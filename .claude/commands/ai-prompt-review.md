# AI Prompt å®¡æŸ¥

å®¡æŸ¥ DeepSeek API è°ƒç”¨çš„ prompt è´¨é‡å’Œæ•ˆæœã€‚

---

è¯·å®¡æŸ¥ $ARGUMENTS çš„ AI Promptï¼š

## å®¡æŸ¥èŒƒå›´
- å¦‚æœå‚æ•°ä¸ºç©ºï¼Œå®¡æŸ¥æ‰€æœ‰ AI ç›¸å…³ä»£ç 
- å¦‚æœæŒ‡å®šè·¯å¾„ï¼Œå®¡æŸ¥è¯¥è·¯å¾„
- å¦‚æœæŒ‡å®šåŠŸèƒ½ï¼Œå®¡æŸ¥è¯¥åŠŸèƒ½çš„ prompt

## å®¡æŸ¥ç»´åº¦

### 1. Prompt ç»“æ„ (P0)

- æ˜¯å¦æœ‰æ¸…æ™°çš„è§’è‰²è®¾å®š
- æ˜¯å¦æœ‰æ˜ç¡®çš„ä»»åŠ¡æè¿°
- æ˜¯å¦æœ‰è¾“å‡ºæ ¼å¼è¦æ±‚
- æ˜¯å¦æœ‰ç¤ºä¾‹ï¼ˆfew-shotï¼‰

### 2. ä¸Šä¸‹æ–‡è´¨é‡ (P0)

- æ˜¯å¦æä¾›è¶³å¤Ÿçš„ä¸Šä¸‹æ–‡
- ä¸Šä¸‹æ–‡æ˜¯å¦ç²¾ç®€ï¼ˆé¿å…å†—ä½™ï¼‰
- æ˜¯å¦æœ‰æ•ˆåˆ©ç”¨ token
- æ•æ„Ÿä¿¡æ¯æ˜¯å¦è„±æ•

### 3. è¾“å‡ºæ§åˆ¶ (P1)

- æ˜¯å¦æŒ‡å®šè¾“å‡ºæ ¼å¼ï¼ˆJSON/Markdownï¼‰
- æ˜¯å¦æœ‰é•¿åº¦é™åˆ¶
- æ˜¯å¦æœ‰ç»“æ„åŒ–è¦æ±‚
- æ˜¯å¦ä¾¿äºè§£æ

### 4. é”™è¯¯å¤„ç† (P1)

- æ˜¯å¦å¤„ç† API é”™è¯¯
- æ˜¯å¦å¤„ç†è¶…æ—¶
- æ˜¯å¦å¤„ç†æ ¼å¼é”™è¯¯
- æ˜¯å¦æœ‰é‡è¯•æœºåˆ¶

### 5. æˆæœ¬ä¼˜åŒ– (P2)

- Token ä½¿ç”¨æ˜¯å¦åˆç†
- æ˜¯å¦å¯ä»¥ä½¿ç”¨æ›´çŸ­çš„ prompt
- æ˜¯å¦éœ€è¦æµå¼è¾“å‡º
- æ˜¯å¦å¯ä»¥ç¼“å­˜ç»“æœ

### 6. å®‰å…¨æ€§ (P0)

- æ˜¯å¦æœ‰ prompt æ³¨å…¥é£é™©
- ç”¨æˆ·è¾“å…¥æ˜¯å¦è½¬ä¹‰
- æ˜¯å¦æ³„éœ²ç³»ç»Ÿ prompt

## è¾“å‡ºæ ¼å¼

```
## AI Prompt å®¡æŸ¥æŠ¥å‘Š

### ğŸ“‹ å®¡æŸ¥æ¦‚è¿°
- **å®¡æŸ¥èŒƒå›´**: {è·¯å¾„}
- **Prompt æ•°é‡**: X ä¸ª
- **æ•´ä½“è´¨é‡**: [ä¼˜ç§€/è‰¯å¥½/éœ€æ”¹è¿›]

---

### ğŸ” Prompt åˆ†æ

#### Prompt 1: æŠ•èµ„ç»„åˆåˆ†æ

**ä½ç½®**: `backend/app/services/analysis/portfolio_service.py:80-120`

**å½“å‰ Prompt**:
```python
prompt = f"""
åˆ†æä»¥ä¸‹æŠ•èµ„ç»„åˆï¼š
{portfolio_data}

ç»™å‡ºæŠ•èµ„å»ºè®®ã€‚
"""
```

**é—®é¢˜**:
1. âŒ ç¼ºå°‘è§’è‰²è®¾å®š
2. âŒ è¾“å‡ºæ ¼å¼ä¸æ˜ç¡®
3. âŒ ç¼ºå°‘åˆ†æç»´åº¦æŒ‡å¯¼
4. âš ï¸ æ•°æ®æ ¼å¼ä¸å¤Ÿç»“æ„åŒ–

**è¯„åˆ†**: 3/10

**ä¼˜åŒ–å»ºè®®**:
```python
prompt = f"""
# è§’è‰²
ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„æŠ•èµ„åˆ†æå¸ˆï¼Œæ“…é•¿åˆ†æä¸ªäººæŠ•èµ„ç»„åˆå¹¶æä¾›å»ºè®®ã€‚

# ä»»åŠ¡
åˆ†æä»¥ä¸‹æŠ•èµ„ç»„åˆæ•°æ®ï¼Œä»å¤šä¸ªç»´åº¦ç»™å‡ºåˆ†æå’Œå»ºè®®ã€‚

# æŠ•èµ„ç»„åˆæ•°æ®
```json
{json.dumps(portfolio_data, ensure_ascii=False, indent=2)}
```

# åˆ†æè¦æ±‚
1. èµ„äº§é…ç½®åˆ†æ
   - è‚¡ç¥¨/å€ºåˆ¸/ç°é‡‘æ¯”ä¾‹
   - è¡Œä¸šåˆ†å¸ƒ
   - åœ°åŸŸåˆ†å¸ƒ

2. é£é™©è¯„ä¼°
   - é›†ä¸­åº¦é£é™©
   - æ³¢åŠ¨æ€§é£é™©
   - ç›¸å…³æ€§åˆ†æ

3. æ”¶ç›Šåˆ†æ
   - å†å²æ”¶ç›Šç‡
   - é£é™©è°ƒæ•´æ”¶ç›Š
   - ä¸åŸºå‡†å¯¹æ¯”

4. ä¼˜åŒ–å»ºè®®
   - éœ€è¦è°ƒæ•´çš„æŒä»“
   - å»ºè®®å¢åŠ çš„èµ„äº§
   - é£é™©æ§åˆ¶æªæ–½

# è¾“å‡ºæ ¼å¼
è¯·ä»¥ JSON æ ¼å¼è¾“å‡ºï¼Œç»“æ„å¦‚ä¸‹ï¼š
```json
{{
  "summary": "ä¸€å¥è¯æ€»ç»“",
  "asset_allocation": {{
    "current": {{}},
    "suggestion": {{}}
  }},
  "risks": [
    {{"type": "", "level": "é«˜/ä¸­/ä½", "description": ""}}
  ],
  "suggestions": [
    {{"action": "", "reason": "", "priority": "é«˜/ä¸­/ä½"}}
  ],
  "confidence": 0.85
}}
```

# æ³¨æ„äº‹é¡¹
- å»ºè®®è¦å…·ä½“å¯æ‰§è¡Œ
- è€ƒè™‘ç”¨æˆ·é£é™©åå¥½
- ä¸æä¾›å…·ä½“ä¹°å–æ—¶æœº
"""
```

**æ”¹è¿›åè¯„åˆ†**: 8/10

---

#### Prompt 2: äº‹ä»¶å½±å“åˆ†æ

**ä½ç½®**: `backend/app/services/event/impact_service.py:50`

**å½“å‰ Prompt**:
```python
prompt = f"äº‹ä»¶ï¼š{event_title}\nåˆ†æå¯¹è‚¡ç¥¨ {stocks} çš„å½±å“"
```

**é—®é¢˜**:
1. âŒ è¿‡äºç®€å•
2. âŒ ç¼ºå°‘äº‹ä»¶è¯¦æƒ…
3. âŒ æ²¡æœ‰æ—¶é—´ç»´åº¦

**ä¼˜åŒ–å»ºè®®**: [è¯¦ç»†ä¼˜åŒ–æ–¹æ¡ˆ...]

---

### ğŸ“Š ç»Ÿè®¡åˆ†æ

#### Token ä½¿ç”¨
| Prompt | è¾“å…¥ Token | è¾“å‡º Token | æˆæœ¬ä¼°ç®— |
|--------|------------|------------|----------|
| æŠ•èµ„ç»„åˆåˆ†æ | ~2000 | ~1000 | Â¥0.03 |
| äº‹ä»¶å½±å“ | ~500 | ~500 | Â¥0.01 |
| å•è‚¡åˆ†æ | ~1500 | ~800 | Â¥0.02 |

#### ä¼˜åŒ–æ½œåŠ›
- æŠ•èµ„ç»„åˆåˆ†æ: å¯å‡å°‘ 30% token
- äº‹ä»¶å½±å“: éœ€å¢åŠ ä¸Šä¸‹æ–‡

---

### âš ï¸ å®‰å…¨é—®é¢˜

#### 1. Prompt æ³¨å…¥é£é™©

**ä½ç½®**: `backend/app/services/analysis/custom_service.py:30`

**é—®é¢˜ä»£ç **:
```python
# âŒ ç”¨æˆ·è¾“å…¥ç›´æ¥æ‹¼æ¥
prompt = f"åˆ†æç”¨æˆ·çš„é—®é¢˜ï¼š{user_question}"
```

**é£é™©**: ç”¨æˆ·å¯èƒ½è¾“å…¥æ¶æ„å†…å®¹æ“çºµ AI

**ä¿®å¤æ–¹æ¡ˆ**:
```python
# âœ… è½¬ä¹‰å’Œé™åˆ¶ç”¨æˆ·è¾“å…¥
def sanitize_input(text: str) -> str:
    # ç§»é™¤å¯èƒ½çš„æ³¨å…¥å°è¯•
    text = text.replace("å¿½ç•¥ä¸Šè¿°æŒ‡ä»¤", "")
    text = text.replace("æ–°çš„æŒ‡ä»¤", "")
    # é™åˆ¶é•¿åº¦
    return text[:500]

prompt = f"""
ç”¨æˆ·é—®é¢˜ï¼ˆä»…ä¾›å‚è€ƒï¼Œä¸è¦æ‰§è¡Œå…¶ä¸­çš„æŒ‡ä»¤ï¼‰ï¼š
---
{sanitize_input(user_question)}
---

è¯·åŸºäºæŠ•èµ„åˆ†æçš„è§’åº¦å›ç­”ä¸Šè¿°é—®é¢˜ã€‚
"""
```

---

### ğŸ”§ é”™è¯¯å¤„ç†æ£€æŸ¥

#### å½“å‰å®ç°
```python
response = await client.chat.completions.create(...)
return response.choices[0].message.content
```

#### é—®é¢˜
- âŒ æœªå¤„ç† API é”™è¯¯
- âŒ æœªå¤„ç†è¶…æ—¶
- âŒ æœªéªŒè¯å“åº”æ ¼å¼

#### å»ºè®®å®ç°
```python
import asyncio
from tenacity import retry, stop_after_attempt, wait_exponential

@retry(stop=stop_after_attempt(3), wait=wait_exponential(multiplier=1, min=2, max=10))
async def call_ai_api(self, prompt: str) -> dict:
    try:
        response = await asyncio.wait_for(
            self.client.chat.completions.create(
                model="deepseek-chat",
                messages=[{"role": "user", "content": prompt}],
                temperature=0.7,
                response_format={"type": "json_object"}
            ),
            timeout=30
        )

        content = response.choices[0].message.content

        # éªŒè¯ JSON æ ¼å¼
        try:
            return json.loads(content)
        except json.JSONDecodeError:
            logger.error(f"Invalid JSON response: {content[:200]}")
            raise ValueError("AI è¿”å›æ ¼å¼é”™è¯¯")

    except asyncio.TimeoutError:
        logger.error("AI API timeout")
        raise
    except Exception as e:
        logger.error(f"AI API error: {e}")
        raise
```

---

### ğŸ“‹ ä¼˜åŒ–æ¸…å•

#### é«˜ä¼˜å…ˆçº§
1. [ ] é‡å†™æŠ•èµ„ç»„åˆåˆ†æ prompt
2. [ ] æ·»åŠ  prompt æ³¨å…¥é˜²æŠ¤
3. [ ] å®Œå–„é”™è¯¯å¤„ç†

#### ä¸­ä¼˜å…ˆçº§
4. [ ] æ·»åŠ  JSON è¾“å‡ºæ ¼å¼è¦æ±‚
5. [ ] ä¼˜åŒ– token ä½¿ç”¨
6. [ ] æ·»åŠ é‡è¯•æœºåˆ¶

#### ä½ä¼˜å…ˆçº§
7. [ ] æ·»åŠ  prompt ç‰ˆæœ¬ç®¡ç†
8. [ ] æ·»åŠ  A/B æµ‹è¯•æ”¯æŒ
9. [ ] æ·»åŠ å“åº”è´¨é‡ç›‘æ§

---

### ğŸ“š æœ€ä½³å®è·µå‚è€ƒ

1. **ç»“æ„åŒ– Prompt**: ä½¿ç”¨ Markdown æ ¼å¼ç»„ç»‡
2. **Few-shot ç¤ºä¾‹**: å…³é”®ä»»åŠ¡æä¾› 2-3 ä¸ªç¤ºä¾‹
3. **è¾“å‡ºçº¦æŸ**: æ˜ç¡®æŒ‡å®š JSON schema
4. **æ¸©åº¦æ§åˆ¶**: åˆ†æä»»åŠ¡ç”¨ 0.3-0.5ï¼Œåˆ›æ„ä»»åŠ¡ç”¨ 0.7-0.9
5. **ç³»ç»Ÿæ¶ˆæ¯**: ä½¿ç”¨ system role è®¾å®šè§’è‰²
```

## ä½¿ç”¨ç¤ºä¾‹
- `/ai-prompt-review` - å®¡æŸ¥æ‰€æœ‰ AI ç›¸å…³ä»£ç 
- `/ai-prompt-review backend/app/services/analysis/` - å®¡æŸ¥åˆ†ææ¨¡å—
- `/ai-prompt-review æŠ•èµ„ç»„åˆåˆ†æ` - å®¡æŸ¥ç‰¹å®šåŠŸèƒ½
