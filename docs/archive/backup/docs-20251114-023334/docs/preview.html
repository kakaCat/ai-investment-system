<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PRD v3 - æŠ•èµ„ç®¡ç†ç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            line-height: 1.6;
            color: #333;
            background: #f5f5f5;
        }

        #app {
            display: flex;
            height: 100vh;
        }

        /* ä¾§è¾¹æ  */
        .sidebar {
            width: 280px;
            background: #2c3e50;
            color: #ecf0f1;
            overflow-y: auto;
            padding: 20px;
        }

        .sidebar h2 {
            color: #3498db;
            margin-bottom: 20px;
            font-size: 18px;
        }

        .sidebar ul {
            list-style: none;
        }

        .sidebar li {
            margin-bottom: 8px;
        }

        .sidebar a {
            color: #ecf0f1;
            text-decoration: none;
            display: block;
            padding: 8px 12px;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .sidebar a:hover {
            background: #34495e;
        }

        /* æ¼”ç¤ºæ§åˆ¶ */
        .demo-controls {
            margin-top: 16px;
            padding-top: 12px;
            border-top: 1px solid rgba(255,255,255,0.2);
        }

        .demo-controls h3 {
            font-size: 14px;
            margin-bottom: 8px;
            color: #bdc3c7;
        }

        .demo-controls button {
            background: #3498db;
            color: #fff;
            border: none;
            padding: 8px 12px;
            margin-right: 8px;
            border-radius: 4px;
            cursor: pointer;
        }

        .demo-controls button:hover {
            background: #2980b9;
        }

        /* ä¸»å†…å®¹åŒº */
        .main-content {
            flex: 1;
            overflow-y: auto;
            background: #fff;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        /* Markdownæ ·å¼ */
        #content h1 {
            color: #2c3e50;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
            margin: 30px 0 20px;
        }

        #content h2 {
            color: #34495e;
            border-bottom: 2px solid #ecf0f1;
            padding-bottom: 8px;
            margin: 25px 0 15px;
        }

        #content h3 {
            color: #555;
            margin: 20px 0 10px;
        }

        #content h4 {
            color: #666;
            margin: 15px 0 8px;
        }

        #content p {
            margin: 10px 0;
        }

        #content ul, #content ol {
            margin: 10px 0;
            padding-left: 30px;
        }

        #content li {
            margin: 5px 0;
        }

        #content code {
            background: #f4f4f4;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 0.9em;
        }

        #content pre {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            margin: 15px 0;
        }

        #content pre code {
            background: none;
            padding: 0;
            color: #ecf0f1;
        }

        #content table {
            border-collapse: collapse;
            width: 100%;
            margin: 15px 0;
        }

        #content table th,
        #content table td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }

        #content table th {
            background: #3498db;
            color: white;
        }

        #content table tr:nth-child(even) {
            background: #f9f9f9;
        }

        #content blockquote {
            border-left: 4px solid #3498db;
            padding-left: 15px;
            margin: 15px 0;
            color: #666;
            font-style: italic;
        }

        /* Mermaidå›¾è¡¨æ ·å¼ */
        .mermaid {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
        }

        /* åŠ è½½æç¤º */
        #loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            font-size: 18px;
            color: #666;
        }

        #loading .loading-wrap {
            display: flex;
            align-items: center;
        }

        #loading .spinner {
            width: 24px;
            height: 24px;
            border: 3px solid #ddd;
            border-top-color: #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 12px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .hidden {
            display: none;
        }

        /* è¿”å›é¡¶éƒ¨æŒ‰é’® */
        #back-to-top {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: #3498db;
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            font-size: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            transition: background 0.3s;
            display: none;
        }

        #back-to-top:hover {
            background: #2980b9;
        }

        #back-to-top.show {
            display: block;
        }
    </style>
</head>
<body>
    <div id="loading"><div class="loading-wrap"><div class="spinner"></div><div>åŠ è½½ä¸­...</div></div></div>

    <div id="app" class="hidden">
        <aside class="sidebar">
            <h2>ğŸ“‹ ç›®å½•</h2>
            <nav id="toc"></nav>
            <div class="demo-controls">
                <h3>ğŸ§ª æ¼”ç¤ºå·¥å…·</h3>
                <button id="show-loading" type="button">æ˜¾ç¤ºåŠ è½½ä¸­</button>
                <button id="hide-loading" type="button">éšè—åŠ è½½ä¸­</button>
            </div>
        </aside>

        <main class="main-content">
            <div class="container">
                <div id="content"></div>
            </div>
        </main>
    </div>

    <button id="back-to-top" title="è¿”å›é¡¶éƒ¨">â†‘</button>

    <!-- Marked.js - Markdownè§£æå™¨ (ä½¿ç”¨å¤šä¸ªCDNå¤‡é€‰) -->
    <script src="https://unpkg.com/marked@11.1.1/marked.min.js"
            onerror="this.onerror=null; this.src='https://cdn.bootcdn.net/ajax/libs/marked/11.1.1/marked.min.js'"></script>
    <!-- Mermaid.js - å›¾è¡¨æ¸²æŸ“ (ä½¿ç”¨å¤šä¸ªCDNå¤‡é€‰) -->
    <script src="https://unpkg.com/mermaid@10.6.1/dist/mermaid.min.js"
            onerror="this.onerror=null; this.src='https://cdn.bootcdn.net/ajax/libs/mermaid/10.6.1/mermaid.min.js'"></script>

    <script>
        let loadTimeout;

        // æ£€æŸ¥ä¾èµ–åº“æ˜¯å¦åŠ è½½
        window.addEventListener('DOMContentLoaded', () => {
            console.log('DOM loaded');
            console.log('marked available:', typeof marked !== 'undefined');
            console.log('mermaid available:', typeof mermaid !== 'undefined');

            // è®¾ç½®è¶…æ—¶æ£€æŸ¥
            loadTimeout = setTimeout(() => {
                if (typeof marked === 'undefined' || typeof mermaid === 'undefined') {
                    document.getElementById('loading').innerHTML =
                        'âš ï¸ CDNåº“åŠ è½½å¤±è´¥<br><br>' +
                        'Marked.js: ' + (typeof marked !== 'undefined' ? 'âœ“' : 'âœ—') + '<br>' +
                        'Mermaid.js: ' + (typeof mermaid !== 'undefined' ? 'âœ“' : 'âœ—') + '<br><br>' +
                        'å¯èƒ½çš„åŸå› ï¼š<br>' +
                        '1. ç½‘ç»œè¿æ¥é—®é¢˜<br>' +
                        '2. CDNè¢«å¢™æˆ–æ— æ³•è®¿é—®<br>' +
                        '3. æµè§ˆå™¨å®‰å…¨è®¾ç½®é˜»æ­¢<br><br>' +
                        '<a href="prd-v3-investment-management.md" target="_blank" style="color: #3498db;">ï¿½ï¿½ï¿½æ¥æŸ¥çœ‹åŸå§‹Markdownæ–‡ä»¶</a>';
                }
            }, 5000);
        });

        // å»¶è¿Ÿåˆå§‹åŒ–ï¼Œç¡®ä¿åº“å·²åŠ è½½
        window.addEventListener('load', () => {
            console.log('Window loaded, initializing...');
            clearTimeout(loadTimeout);

            // ç­‰å¾…ä¸€å°æ®µæ—¶é—´ç¡®ä¿è„šæœ¬æ‰§è¡Œå®Œæˆ
            setTimeout(() => {
                try {
                    // åˆå§‹åŒ–Mermaid
                    if (typeof mermaid !== 'undefined') {
                        mermaid.initialize({
                            startOnLoad: true,
                            theme: 'default',
                            securityLevel: 'loose',
                            fontFamily: 'Arial, sans-serif'
                        });
                        console.log('Mermaid initialized');
                    }

                    // é…ç½®Marked
                    if (typeof marked !== 'undefined') {
                        marked.setOptions({
                            breaks: true,
                            gfm: true
                        });
                        console.log('Marked configured');
                    }

                    // æ ¹æ®URLå‚æ•°æ§åˆ¶æ¼”ç¤ºåŠ è½½æ€
                    const params = new URLSearchParams(window.location.search);
                    const demoLoading = params.get('loading') === '1';
                    const loadingMs = parseInt(params.get('loadingMs') || '0', 10);

                    if (demoLoading) {
                        console.log('Demo loading mode is ON');
                        // ä¿æŒåŠ è½½æ€å¯è§
                        document.getElementById('loading').classList.remove('hidden');
                        document.getElementById('app').classList.add('hidden');

                        if (loadingMs > 0) {
                            console.log('Delaying markdown load by', loadingMs, 'ms');
                            setTimeout(() => {
                                try {
                                    loadMarkdown();
                                } catch (error) {
                                    console.error('Delayed load error:', error);
                                    document.getElementById('loading').textContent = 'åˆå§‹åŒ–å¤±è´¥: ' + error.message;
                                }
                            }, loadingMs);
                        } else {
                            console.log('Holding on loading screen (no auto load)');
                            return; // ä¸ç»§ç»­åŠ è½½å†…å®¹ï¼Œä¿ç•™åŠ è½½æ€
                        }
                    } else {
                        // æ­£å¸¸åŠ è½½Markdown
                        loadMarkdown();
                    }
                } catch (error) {
                    console.error('Initialization error:', error);
                    document.getElementById('loading').textContent = 'åˆå§‹åŒ–å¤±è´¥: ' + error.message;
                }
            }, 500);
        });

        // åŠ è½½Markdownæ–‡ä»¶
        async function loadMarkdown() {
            console.log('Starting to load markdown...');
            try {
                if (typeof marked === 'undefined') {
                    throw new Error('Marked.js æœªåŠ è½½');
                }
                if (typeof mermaid === 'undefined') {
                    throw new Error('Mermaid.js æœªåŠ è½½');
                }

                console.log('Fetching markdown file...');
                const response = await fetch('prd-v3-investment-management.md');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                console.log('Parsing markdown...');
                const text = await response.text();
                const html = marked.parse(text);
                document.getElementById('content').innerHTML = html;

                console.log('Rendering mermaid diagrams...');
                await mermaid.run();

                console.log('Generating TOC...');
                generateTOC();

                // éšè—åŠ è½½æç¤º
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('app').classList.remove('hidden');

                console.log('Load complete!');

                // å¦‚æœURLæœ‰hashï¼Œæ»šåŠ¨åˆ°å¯¹åº”ä½ç½®
                if (window.location.hash) {
                    setTimeout(() => {
                        const element = document.querySelector(window.location.hash);
                        if (element) element.scrollIntoView();
                    }, 100);
                }
            } catch (error) {
                console.error('Load error:', error);
                document.getElementById('loading').innerHTML =
                    'åŠ è½½å¤±è´¥: ' + error.message + '<br><br>' +
                    'è¯·æ£€æŸ¥ï¼š<br>' +
                    '1. æ˜¯å¦æ­£ç¡®å¯åŠ¨äº† http-server<br>' +
                    '2. prd-v3-investment-management.md æ–‡ä»¶æ˜¯å¦å­˜åœ¨<br>' +
                    '3. æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°æŸ¥çœ‹è¯¦ç»†é”™è¯¯';
            }
        }

        // ç”Ÿæˆç›®å½•
        function generateTOC() {
            const headers = document.querySelectorAll('#content h2, #content h3');
            const toc = document.getElementById('toc');
            const ul = document.createElement('ul');

            headers.forEach((header, index) => {
                // ç»™æ ‡é¢˜æ·»åŠ ID
                const id = `header-${index}`;
                header.id = id;

                const li = document.createElement('li');
                const a = document.createElement('a');
                a.href = `#${id}`;
                a.textContent = header.textContent;

                // H3ç¼©è¿›
                if (header.tagName === 'H3') {
                    a.style.paddingLeft = '20px';
                    a.style.fontSize = '0.9em';
                }

                a.addEventListener('click', (e) => {
                    e.preventDefault();
                    header.scrollIntoView({ behavior: 'smooth' });
                    window.history.pushState(null, '', `#${id}`);
                });

                li.appendChild(a);
                ul.appendChild(li);
            });

            toc.appendChild(ul);
        }

        // è¿”å›é¡¶éƒ¨æŒ‰é’®
        const backToTop = document.getElementById('back-to-top');
        const mainContent = document.querySelector('.main-content');

        mainContent.addEventListener('scroll', () => {
            if (mainContent.scrollTop > 300) {
                backToTop.classList.add('show');
            } else {
                backToTop.classList.remove('show');
            }
        });

        backToTop.addEventListener('click', () => {
            mainContent.scrollTo({ top: 0, behavior: 'smooth' });
        });

        // æ‰‹åŠ¨åˆ‡æ¢åŠ è½½æ€
        const showBtn = document.getElementById('show-loading');
        const hideBtn = document.getElementById('hide-loading');
        if (showBtn && hideBtn) {
            showBtn.addEventListener('click', () => {
                document.getElementById('loading').classList.remove('hidden');
                document.getElementById('app').classList.add('hidden');
            });
            hideBtn.addEventListener('click', () => {
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('app').classList.remove('hidden');
            });
        }
    </script>
</body>
</html>
