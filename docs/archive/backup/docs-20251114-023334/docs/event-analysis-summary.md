# 事件分析增强设计总结

**版本**: v1.0
**日期**: 2025-01-14
**状态**: 设计完成,待实施

---

## 1. 需求背景

用户需求: **AI会参考政策事件和公司事件来分析整个股市和个股**

实现策略: **增强现有设计**,在现有NewsAdapter基础上添加事件分类和影响分析功能

---

## 2. 设计成果

### 2.1 核心文档

| 文档 | 描述 | 主要内容 |
|------|------|---------|
| `event-analysis-enhancement.md` | 事件分析增强总体设计 | 数据库表结构、架构设计、定时任务、API设计、前端UI、实施计划 |
| `event-adapter-implementation.md` | EventAdapter实现设计 | 类型定义、适配器实现、AI分析扩展、DataService、性能优化 |
| `ai-event-integration.md` | AI事件集成设计 | 各场景事件引用机制、Prompt设计、响应格式、性能优化 |

### 2.2 功能亮点

#### ✨ 事件追踪与分类
- **四大类事件**: 政策事件、公司事件、市场事件、行业事件
- **16种子类型**: 涵盖货币政策、财报发布、市场情绪、技术突破等
- **重要性分级**: Critical/High/Medium/Low四级,AI智能评估
- **影响量化**: 影响方向(利好/利空/中性/复杂) + 影响强度(0-100)

#### ✨ AI智能分析
- **事件影响评估**: AI自动分析每个事件的影响方向、强度和摘要
- **个股影响分析**: 详细分析事件对特定股票的影响,预测价格变化
- **批量处理优化**: 支持批量分析多个事件,减少API调用成本

#### ✨ 全场景集成
- **单股分析**: 结合近30-90天相关事件,提供事件驱动的投资建议
- **持仓分析**: 实时事件告警,突出显示影响持仓的重大事件
- **选股推荐**: 基于市场环境和政策导向,推荐受益于利好事件的股票
- **策略生成**: 策略分析时自动引用相关事件,增强决策依据

#### ✨ 数据管理
- **幂等性保证**: 通过idempotency_key防止事件重复
- **相似性检测**: 智能识别并合并相似事件
- **多级缓存**: 内存缓存 + Redis缓存,优化查询性能
- **批量操作**: 支持批量导入、批量分析,提升效率

---

## 3. 技术架构

### 3.1 数据库设计

#### 核心表

**events (事件表)**
- 事件基本信息、分类、影响范围
- AI分析结果(影响方向、强度、摘要)
- 幂等键、处理状态
- **索引**: 类型、时间、重要性、股票代码(GIN)、行业(GIN)

**event_stock_impacts (事件股票影响表)**
- 事件对单只股票的详细影响分析
- 预期价格变化 vs 实际价格变化(用于回测)
- **索引**: 事件ID、股票代码、影响方向

#### 表结构扩展

**strategy_analysis (扩展)**
- 新增 `related_events` JSONB字段
- 记录策略分析时引用的事件及相关性

**ai_analysis_history (扩展)**
- 新增 `related_events` JSONB字段
- 记录AI分析历史中引用的事件

### 3.2 分层架构

```
┌─────────────────────────────────────────────┐
│              Controller 层                   │
│  EventController | StockController (增强)    │
└─────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────┐
│               Service 层                     │
│  EventService | StockService (增强)         │
│  StrategyService (增强) | PortfolioService  │
└─────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────┐
│            DataService 层                    │
│  EventDataService (新增)                    │
│  MarketDataService | PortfolioDataService   │
└─────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────┐
│            Repository 层                     │
│  EventRepository (新增)                     │
│  EventImpactRepository (新增)               │
└─────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────┐
│             Adapter 层                       │
│  EventAdapter (新增) | NewsAdapter (增强)   │
│  ClaudeAdapter (扩展事件分析能力)           │
└─────────────────────────────────────────────┘
```

### 3.3 核心组件

#### EventAdapter
- **职责**: 从MCP服务获取事件数据,统一格式,去重
- **关键方法**:
  - `fetchRecentEvents()`: 获取最新事件
  - `fetchSymbolEvents()`: 获取股票相关事件
  - `fetchSectorEvents()`: 获取行业事件
  - `fetchMarketEvents()`: 获取市场级事件

#### EventDataService
- **职责**: 事件数据聚合访问,缓存管理
- **策略**: 缓存优先 → 数据库 → MCP拉取并落库
- **关键方法**:
  - `getRelevantEvents()`: 获取相关事件
  - `saveEvents()`: 保存事件(带去重)
  - `getEventImpacts()`: 获取事件影响分析

#### ClaudeAdapter (扩展)
- **新增能力**:
  - `analyzeEvent()`: 分析事件影响(通用)
  - `analyzeEventImpact()`: 分析事件对个股影响
  - `analyzEventsBatch()`: 批量分析事件(优化版本)

---

## 4. 定时任务

### 4.1 事件收集任务
- **频率**: 每小时执行一次
- **流程**:
  1. 从MCP获取最新事件
  2. 去重(通过幂等键)
  3. AI增强(分析影响)
  4. 保存到数据库
  5. 触发影响分析任务

### 4.2 事件影响分析任务
- **触发方式**: 事件收集后异步执行
- **流程**:
  1. 确定受影响股票列表
  2. 对每只股票进行影响分析
  3. 保存影响分析结果
  4. 标记事件为已处理

---

## 5. API设计

### 5.1 事件管理API

```
GET  /api/events                    # 获取事件列表(支持筛选)
GET  /api/events/:id                # 获取事件详情
GET  /api/stocks/:symbol/events     # 获取股票相关事件
POST /api/events/collect            # 手动触发事件收集
POST /api/events                    # 手动添加事件
```

### 5.2 增强的AI分析API

```
POST /api/ai/analyze/portfolio      # 持仓分析(增强,包含事件)
  - includeEvents: boolean
  - eventLookbackDays: number

POST /api/ai/analyze/stock          # 单股分析(增强,包含事件)
  - includeEvents: boolean
  - eventLookbackDays: number

响应中新增:
  - relatedEvents: Event[]
  - eventAnalysis: {...}
  - eventAlerts: EventAlert[]
```

---

## 6. 前端设计

### 6.1 事件中心页面(新增)
- 事件列表(按类型、重要性、时间筛选)
- 事件详情(影响分析、受影响股票)
- 实时事件推送(WebSocket/SSE)

### 6.2 股票详情页(增强)
- 新增"相关事件"区块
- 展示近30天相关事件
- 按利好/利空分类展示
- AI影响分析摘要

### 6.3 持仓分析页(增强)
- 新增"事件告警"卡片
- 突出显示影响持仓的重大事件
- 提供基于事件的操作建议

---

## 7. 实施计划

### Phase 1: 数据库与基础设施 (1周)
- ✅ 设计完成
- [ ] 创建事件表结构
- [ ] 扩展现有表
- [ ] 编写数据库迁移脚本
- [ ] 创建Repository层

### Phase 2: Adapter与DataService (1-2周)
- ✅ 设计完成
- [ ] 实现EventAdapter
- [ ] 增强NewsAdapter
- [ ] 实现EventDataService
- [ ] 编写单元测试

### Phase 3: Service层与AI集成 (2周)
- ✅ 设计完成
- [ ] 增强StrategyService
- [ ] 增强StockService
- [ ] 实现事件收集定时任务
- [ ] 实现事件影响分析任务
- [ ] AI Prompt优化

### Phase 4: API与前端 (2周)
- ✅ 设计完成
- [ ] 实现事件管理API
- [ ] 增强AI分析API
- [ ] 前端事件中心页面
- [ ] 前端股票详情页事件区块
- [ ] 前端持仓分析结果事件卡片

### Phase 5: 测试与优化 (1周)
- [ ] 端到端测试
- [ ] 性能优化
- [ ] AI分析质量评估
- [ ] 文档完善

**总计**: 7-8周

---

## 8. 关键技术要点

### 8.1 去重策略
- 使用 `external_id` 作为外部事件唯一标识
- 使用 `idempotency_key` (SHA256哈希) 防止重复导入
- 相似事件检测(标题Jaccard相似度>80% + 时间差<24h)

### 8.2 AI分析优化
- 批量分析(每批5个事件,减少API调用)
- 缓存事件影响分析结果(24小时TTL)
- 渐进式分析(Critical事件优先,Low事件延后)

### 8.3 性能优化
- 事件表按时间分区(月度分区)
- GIN索引优化数组查询(symbols, sectors)
- Redis缓存热点事件(7天内的critical/high事件)
- 多级缓存(内存 + Redis)

### 8.4 数据质量保证
- AI分析结果置信度评分
- 人工审核机制(Critical事件)
- 事件来源可追溯
- 影响分析准确性回测(MAE/RMSE)

---

## 9. 风险与挑战

| 风险 | 影响 | 缓解措施 |
|------|------|----------|
| MCP事件数据源不稳定 | 事件收集失败 | 多数据源备份、降级策略 |
| AI分析成本高 | 运营成本增加 | 分级处理、批量分析、缓存优化 |
| 事件影响预测不准 | 用户信任度下降 | 置信度评分、回测优化、人工审核 |
| 事件数据量大 | 数据库性能下降 | 分区表、归档策略、索引优化 |
| 事件去重不准确 | 重复事件 | 多重去重策略(外部ID + 标题相似度) |

---

## 10. 成功指标

### 10.1 技术指标
- 事件收集成功率: >95%
- 事件去重准确率: >90%
- AI分析响应时间: <10秒
- 事件查询性能: <500ms (P99)

### 10.2 业务指标
- 事件影响预测准确性: MAE <5% (价格变化)
- 用户事件查看率: >30%
- AI分析中事件引用率: >80%
- 用户满意度: 4.0/5.0+

### 10.3 覆盖指标
- 事件覆盖股票数: >1000只
- 每日新增事件数: 50-200条
- Critical/High事件占比: 20-30%
- 事件数据源多样性: ≥3个MCP源

---

## 11. 未来扩展

### 11.1 短期(3-6个月)
- [ ] 事件订阅与推送(WebSocket/SSE)
- [ ] 每日事件摘要邮件
- [ ] 事件情绪分析(NLP)
- [ ] 事件关键词提取与标签

### 11.2 中期(6-12个月)
- [ ] 事件知识图谱(事件间关联关系)
- [ ] 事件链分析(因果关系)
- [ ] 自定义事件(用户手动添加)
- [ ] 社区事件分享与讨论

### 11.3 长期(12个月+)
- [ ] 事件预测(基于历史数据预测未来事件)
- [ ] 事件驱动策略回测
- [ ] 多语言事件支持(国际市场)
- [ ] 事件相似度推荐

---

## 12. 总结

### 12.1 设计亮点
✅ **完整的四层事件体系**: 政策/公司/市场/行业全覆盖
✅ **AI驱动的影响分析**: 自动评估事件影响方向、强度和预期变化
✅ **全场景深度集成**: 单股分析、持仓分析、选股推荐全面引入事件分析
✅ **高性能架构**: 多级缓存、批量处理、分区表优化
✅ **可追溯性**: 记录AI分析时引用的事件,支持回测验证

### 12.2 价值体现
🎯 **提升AI分析质量**: 事件作为重要上下文,让AI建议更及时、更准确
🎯 **增强用户信心**: 透明展示事件影响,让投资决策有据可依
🎯 **差异化竞争力**: 事件驱动分析是专业投资平台的核心能力
🎯 **降低投资风险**: 实时事件告警,及时发现影响持仓的重大事件

### 12.3 下一步行动
1. ✅ 完成详细设计(已完成)
2. 评审设计方案,确定优先级
3. 启动Phase 1开发(数据库与基础设施)
4. 配置MCP事件数据源
5. 开发核心功能并测试
6. 逐步上线并迭代优化

---

**文档状态**: 设计完成,待评审与实施

**相关文档**:
- 详细设计: `docs/event-analysis-enhancement.md`
- 实现设计: `docs/event-adapter-implementation.md`
- AI集成设计: `docs/ai-event-integration.md`
- 架构总览: `docs/README.md`
