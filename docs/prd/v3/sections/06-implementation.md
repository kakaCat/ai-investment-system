# PRD v3 — AI驱动的个人投资管理与复盘系统

**版本**: v3.1
**状态**: 待评审
**日期**: 2025-01-14
**范围**: 多账户投资管理、AI策略生成、策略复盘、资金流动性管理、事件分析与追踪

**v3.1 更新**:
- ✨ 新增完整的事件分析与追踪体系（2.9章节）
  - 四大类事件（政策/公司/市场/行业）、16种子类型
  - AI事件影响分析与预测
  - 事件时间线与可视化
  - 事件与持仓/策略的深度集成
  - 定时任务与智能提醒

---
## 5. 技术架构

### 5.1 技术栈
**后端**：
- TypeScript + NestJS
- PostgreSQL 14+
- Prisma ORM
- JWT认证
- Claude API（AI分析）
- MCP客户端（股票数据）
- BullMQ（可选，定时任务）
- Redis（缓存、会话）

**前端**：
- React 18 + TypeScript
- Ant Design / shadcn/ui
- Zustand / Redux Toolkit
- Apache ECharts（图表）
- Axios

**部署**：
- Docker + Docker Compose
- Nginx

### 5.2 MCP集成
- **A股数据**：akshare MCP服务器
- **港股/美股数据**：自建或第三方MCP服务器
- **数据刷新**：用户手动触发，通过MCP获取最新价格

---

## 6. 实施计划

### Phase 1：基础框架（2周）
- [ ] 项目搭建（NestJS + React）
- [ ] 数据库设计 + Prisma Schema
- [ ] 用户认证（注册/登录/JWT）
- [ ] AI Token管理
- [ ] 前端布局框架

### Phase 2：账户与持仓（2周）
- [ ] 账户管理CRUD
- [ ] 资金管理（总资金、已投资、流动资金）
- [ ] 股票信息库（多市场支持）
- [ ] 持仓管理CRUD
- [ ] 手动刷新价格（MCP集成）

### Phase 3：交易与关注（1周）
- [ ] 交易记录管理
- [ ] 关注列表管理
- [ ] 已实现盈亏计算

### Phase 4：AI集成（2周）
- [ ] Claude API集成
- [ ] 整体持仓分析
- [ ] 单股深度分析
- [ ] 投资机会发现
- [ ] Token消耗追踪

### Phase 5：策略与复盘（2周）
- [ ] 策略记录（自动保存AI分析结果）
- [ ] 策略回顾看板
- [ ] 策略执行标记
- [ ] 复盘功能
  - 执行率统计
  - 准确率统计
  - 资金利用率分析
- [ ] 策略评估

### Phase 6：可视化与优化（2周）
- [ ] 仪表板（总览、账户列表、AI提醒）
- [ ] 持仓页面（表格、图表）
- [ ] 策略回顾可视化
- [ ] 复盘报告可视化
- [ ] 性能优化

### Phase 7：测试与上线（1周）
- [ ] 测试（单元、集成、端到端）
- [ ] Docker部署
- [ ] 数据备份策略
- [ ] 上线

---

## 7. 关键功能示例

### 7.1 AI分析流程（基于流动资金）

```
用户点击"分析持仓"
  ↓
1. 后端读取账户数据
   - 总资金：30万
   - 已投资：14.5万（48.3%）
   - 流动资金：15.5万（51.7%）
  ↓
2. 读取持仓列表
   - 青岛啤酒：1600股 @ 78.4元，现价65.8元
   - 腾讯控股：100股 @ 632港元，现价650港元
   - ...
  ↓
3. 通过MCP获取最新数据
   - 实时价格
   - 公司财报
   - 近期新闻
  ↓
4. 构建AI Prompt
   """
   你是投资顾问。分析以下账户：

   【账户信息】
   - 总资金：30万
   - 已投资：14.5万（48.3%）
   - 流动资金：15.5万（51.7%）← 重点

   【持仓明细】
   1. 青岛啤酒（600600）
      - 数量：1600股，成本：78.4元，现价：65.8元
      - 盈亏：-20,169元（-16.1%）
      - 最小交易单位：100股
   ...

   请提供：
   1. 每只股票的操作建议（结合流动资金）
   2. 流动资金使用建议（应该买什么、买多少）
   3. 组合优化建议
   """
  ↓
5. 调用Claude API
   - 消耗tokens：2500
   - 更新用户余额：100,000 → 97,500
  ↓
6. 解析AI响应
  ↓
7. 保存到ai_strategies表
   - 记录建议内容
   - 记录持仓快照
   - 记录资金快照
   - 记录tokens消耗
  ↓
8. 返回结果给前端
```

### 7.2 策略复盘流程

```
用户点击"周度复盘"
  ↓
1. 查询本周所有AI策略
   - 时间范围：2025-11-01 ~ 2025-11-07
   - 总策略数：20条
  ↓
2. 统计执行情况
   - 已执行：12条（60%）
   - 未执行：8条（40%）
     * 价格未到：5条
     * 资金不足：2条
     * 手动放弃：1条
  ↓
3. 评估已执行策略
   - 对每条已执行策略：
     * 查询当时建议价格
     * 查询实际执行价格
     * 查询当前价格
     * 计算收益率
  ↓
4. 评估未执行策略
   - 对每条未执行策略：
     * 假设按建议价格执行
     * 计算假设收益
     * 对比实际情况（错过or避免亏损）
  ↓
5. 生成复盘报告
   - 执行率：60%
   - 准确率：66.7%
   - 平均收益：+3.2%
   - 资金利用率：55%
   - 改进建议：...
  ↓
6. 可视化展示
   - 图表：执行率饼图、收益柱状图、净值曲线
```

---

## 8. 风险与挑战

### 8.1 技术风险
| 风险 | 影响 | 缓解措施 |
|------|------|----------|
| MCP服务不稳定 | 价格获取失败 | 多MCP源备份、手动输入降级 |
| Claude API限流 | AI功能不可用 | 重试机制、队列 |
| 数据库性能 | 查询慢 | 索引优化、缓存 |
| 汇率转换 | 跨市场资金计算不准 | 接入汇率API |

### 8.2 产品风险
| 风险 | 影响 | 缓解措施 |
|------|------|----------|
| AI建议不准确 | 用户亏损 | 免责声明、用户教育 |
| 流动资金计算错误 | 操作建议失误 | 严格测试、人工审核 |
| Token消耗过快 | 成本高 | 限制调用频率、提供套餐 |

---

## 9. 成功指标

### MVP阶段（3个月）
- 注册用户：100+
- 日活用户：20+
- AI分析调用：200+/周
- 策略记录：500+条
- 用户留存（7日）：40%+

### 产品成熟期（6个月）
- 注册用户：500+
- 月活用户：100+
- AI策略准确率：60%+
- 用户平均收益率：正收益
- Token购买转化率：30%+

---

## 10. 未来扩展

### Phase 2（6个月后）
- [ ] OCR导入持仓
- [ ] 移动端App
- [ ] 策略回测（历史数据回测）
- [ ] 智能提醒（价格到达、止损触发）
- [ ] 社区功能（分享策略）

### Phase 3（12个月后）
- [ ] 量化策略（简化版PRD v2）
- [ ] 多用户协作（家庭账户）
- [ ] 付费订阅模式
- [ ] 开放API（第三方接入）

---

## 11. 附录

### 11.1 交易规则参考
**A股：**
- 最小单位：100股（1手）
- 涨跌幅：±10%（ST股±5%，科创板/创业板±20%）
- 交易时间：9:30-11:30, 13:00-15:00

**港股：**
- 最小单位：不固定（每只股票不同）
  - 腾讯（00700）：100股
  - 阿里（09988）：100股
  - 比亚迪（01211）：500股
- 涨跌幅：无限制
- 交易时间：9:30-12:00, 13:00-16:00

**美股：**
- 最小单位：1股
- 涨跌幅：无限制
- 交易时间：09:30-16:00 ET（夏令时）

---

**变更记录**
| 版本 | 日期 | 变更内容 | 作者 |
|------|------|----------|------|
| v3.0 | 2025-01-13 | 基于用户反馈重新设计 | Claude |

---
