# PRD v3 — AI驱动的个人投资管理与复盘系统

**版本**: v3.1
**状态**: 待评审
**日期**: 2025-01-14
**范围**: 多账户投资管理、AI策略生成、策略复盘、资金流动性管理、事件分析与追踪

**v3.1 更新**:
- ✨ 新增完整的事件分析与追踪体系（2.9章节）
  - 四大类事件（政策/公司/市场/行业）、16种子类型
  - AI事件影响分析与预测
  - 事件时间线与可视化
  - 事件与持仓/策略的深度集成
  - 定时任务与智能提醒

---
## 3. 场景用例与流程图

### 3.1 用户故事（User Stories）

#### 3.1.1 新用户注册与首次使用
**作为** 一个新用户
**我想要** 注册账号并创建我的第一个账户
**以便于** 开始管理我的股票投资

**验收标准**：
- 用户可以通过邮箱注册
- 注册后自动登录
- 引导用户创建第一个账户（券商账户）
- 配置交易费用
- 赠送1万tokens试用

**流程**：
1. 访问注册页面
2. 输入用户名、邮箱、密码
3. 验证邮箱（可选）
4. 自动登录
5. 引导页："创建你的第一个账户"
6. 输入账户信息（华泰证券、总资金30万、佣金万3）
7. 完成，进入仪表板

---

#### 3.1.2 导入现有持仓
**作为** 一个已有持仓的投资者
**我想要** 快速导入我的持仓信息
**以便于** 立即开始使用AI分析

**验收标准**：
- 支持手动逐条添加
- 支持CSV批量导入
- 自动计算持仓市值和盈亏
- 自动更新账户的已投资金额和流动资金

**流程**：
1. 进入"华泰证券"账户
2. 点击"添加持仓"或"批量导入"
3. 手动输入：
   - 股票代码：600600
   - 数量：1600股
   - 平均成本：78.4元
4. 点击"刷新价格"（通过MCP获取当前价：65.8元）
5. 系统自动计算：
   - 市值：105,280元
   - 盈亏：-20,169元（-16.1%）
6. 更新账户资金：
   - 已投资金额增加105,280元
   - 流动资金减少105,280元

---

#### 3.1.3 AI分析整体持仓
**作为** 一个持有多只股票的投资者
**我想要** AI分析我的整体持仓并给出操作建议
**以便于** 做出更好的投资决策

**验收标准**：
- AI分析所有持仓股票
- 基于流动资金给出操作建议
- 显示组合层面的风险提示
- 记录策略到数据库供后续复盘
- 扣除相应tokens

**流程**：
1. 点击"AI分析持仓"
2. 选择账户（或分析所有账户）
3. 系统收集数据：
   - 账户资金情况（总资金、已投资、流动资金）
   - 所有持仓信息
   - 通过MCP获取最新价格和公司信息
4. 调用Claude API分析
5. 显示分析结果：
   - 每只股票的操作建议
   - 流动资金使用建议
   - 组合优化建议
6. 保存策略到ai_strategies表
7. 扣除tokens（约2500）
8. 提示：剩余97,500 tokens

---

#### 3.1.4 执行AI建议并记录
**作为** 一个认同AI建议的投资者
**我想要** 执行AI建议并记录交易
**以便于** 后续复盘策略效果

**验收标准**：
- 可以查看AI历史建议
- 执行交易时自动计算费用
- 交易完成后可以标记对应策略为"已执行"
- 更新持仓和账户资金

**流程**：
1. 查看策略回顾看板
2. 找到"2025-01-13的建议：青岛啤酒62-64元加仓500股"
3. 当前价格：63元（满足条件）
4. 点击"执行交易"
5. 跳转到交易录入页面（自动填充）：
   - 股票：600600
   - 操作：买入
   - 数量：500股
   - 价格：63元
6. 系统自动计算费用：
   - 成交金额：31,500元
   - 佣金：9.45元
   - 总费用：12.06元
   - 实际成本：31,512.06元
7. 确认提交
8. 更新持仓：
   - 原有：1600股 @ 78.4元
   - 新增：500股 @ 63元
   - 新平均成本：75.72元（加权平均）
9. 标记策略"已执行"
10. 记录执行信息供复盘

---

#### 3.1.5 周度复盘
**作为** 一个注重复盘的投资者
**我想要** 每周复盘AI策略的执行情况和效果
**以便于** 改进我的投资纪律和决策质量

**验收标准**：
- 显示本周所有AI策略
- 统计执行率和准确率
- 计算已执行策略的实际收益
- 分析未执行策略的机会成本
- 给出改进建议

**流程**：
1. 点击"策略复盘"
2. 选择"本周（2025-01-06至2025-01-12）"
3. 显示统计：
   - 总策略数：20条
   - 已执行：12条（60%）
   - 未执行：8条（40%）
     * 价格未到：5条
     * 资金不足：2条
     * 手动放弃：1条
4. 已执行策略效果：
   - 盈利：8条（66.7%）
   - 亏损：4条（33.3%）
   - 平均收益：+3.2%
5. 未执行策略分析：
   - 错过机会：宁德时代建议买入未执行，错过+5.2%
   - 避免亏损：万科A建议加仓未执行，避免-8%
6. 改进建议：
   - 提高执行纪律，特别是价格到位时
   - 保持充足流动资金（当前45%）
   - 设置价格提醒避免错过

---

### 3.2 核心流程图

#### 3.2.1 用户注册与账户创建流程

```mermaid
flowchart TD
    A[访问注册页面] --> B[填写注册信息]
    B --> C{验证信息}
    C -->|失败| B
    C -->|成功| D[创建用户]
    D --> E[赠送10000 tokens]
    E --> F[自动登录]
    F --> G[引导创建第一个账户]
    G --> H[填写账户信息]
    H --> I[配置交易费用]
    I --> J[保存账户]
    J --> K[进入仪表板]
```

---

#### 3.2.2 持仓导入与价格刷新流程

```mermaid
flowchart TD
    A[点击添加持仓] --> B{选择导入方式}
    B -->|手动添加| C[输入股票代码、数量、成本]
    B -->|CSV导入| D[上传CSV文件]
    D --> E[解析CSV数据]
    E --> C
    C --> F[验证股票代码]
    F -->|不存在| G[从MCP获取股票信息]
    G --> H[保存到stocks表]
    F -->|已存在| I[保存持仓到holdings表]
    H --> I
    I --> J[点击刷新价格]
    J --> K[通过MCP获取最新价格]
    K --> L[更新current_price]
    L --> M[计算市值和盈亏]
    M --> N[更新账户资金]
    N --> O[显示持仓列表]
```

---

#### 3.2.3 AI整体持仓分析流程

```mermaid
flowchart TD
    A[点击AI分析持仓] --> B[选择账户]
    B --> C{检查tokens余额}
    C -->|不足| D[提示购买tokens]
    D --> E[跳转到购买页面]
    C -->|充足| F[收集账户数据]
    F --> G[读取持仓列表]
    G --> H[通过MCP获取最新价格]
    H --> I[通过MCP获取公司信息]
    I --> J[构建AI Prompt]
    J --> K[调用Claude API]
    K --> L[解析AI响应]
    L --> M[保存到ai_strategies表]
    M --> N[扣除tokens约2500]
    N --> O[更新用户tokens余额]
    O --> P[显示分析结果]
    P --> Q{用户操作}
    Q -->|查看详情| R[展开某只股票分析]
    Q -->|执行建议| S[跳转到交易录入]
    Q -->|忽略| T[返回仪表板]
```

---

#### 3.2.4 交易录入与费用计算流程

```mermaid
flowchart TD
    A[点击添加交易] --> B[选择股票]
    B --> C[输入交易信息]
    C --> D[交易类型、数量、价格]
    D --> E[读取账户fee_config]
    E --> F[计算成交金额]
    F --> G{交易类型}
    G -->|买入| H[计算佣金]
    G -->|卖出| I[计算佣金+印花税]
    H --> J[计算过户费]
    I --> J
    J --> K[计算其他费用]
    K --> L[汇总总费用]
    L --> M{交易类型}
    M -->|买入| N[实际成本=成交金额+总费用]
    M -->|卖出| O[实际收入=成交金额-总费用]
    N --> P[保存到trade_records]
    O --> Q[计算已实现盈亏FIFO]
    Q --> P
    P --> R[更新持仓数量和成本]
    R --> S[更新账户资金]
    S --> T{关联AI策略?}
    T -->|是| U[标记策略已执行]
    T -->|否| V[完成]
    U --> V
```

---

#### 3.2.5 AI策略复盘流程

```mermaid
flowchart TD
    A[点击策略复盘] --> B[选择复盘周期]
    B --> C[查询ai_strategies表]
    C --> D[获取本周期所有策略]
    D --> E[统计执行情况]
    E --> F[已执行策略]
    F --> G[查询对应交易记录]
    G --> H[计算实际收益]
    H --> I[与AI预测对比]
    I --> J[计算准确率]
    E --> K[未执行策略]
    K --> L[获取当前价格]
    L --> M[计算假设收益]
    M --> N[机会成本分析]
    J --> O[汇总统计数据]
    N --> O
    O --> P[生成复盘报告]
    P --> Q[显示可视化图表]
    Q --> R[AI生成改进建议]
```

---

#### 3.2.6 手动刷新价格流程

```mermaid
flowchart TD
    A[点击刷新价格] --> B{刷新范围}
    B -->|单只股票| C[获取该股票symbol]
    B -->|全部持仓| D[获取所有持仓symbols]
    C --> E[调用MCP获取价格]
    D --> F[批量调用MCP获取价格]
    F --> E
    E --> G{MCP响应}
    G -->|成功| H[更新holdings.current_price]
    G -->|失败| I[显示错误提示]
    I --> J[保留原有价格]
    H --> K[计算新的市值和盈亏]
    K --> L[保存价格快照到price_snapshots]
    L --> M[更新账户已投资金额]
    M --> N[刷新页面显示]
```

---

#### 3.2.7 策略执行标记流程

```mermaid
flowchart TD
    A[查看策略回顾看板] --> B[浏览策略列表]
    B --> C[点击某条策略]
    C --> D[显示策略详情]
    D --> E{价格是否到位?}
    E -->|是| F[点击执行交易]
    E -->|否| G[标记未执行原因]
    F --> H[跳转到交易录入页面]
    H --> I[自动填充交易信息]
    I --> J[用户确认并提交]
    J --> K[保存交易记录]
    K --> L[更新持仓]
    L --> M[更新策略表]
    M --> N[设置is_executed=true]
    N --> O[记录executed_at和execution_notes]
    G --> P[更新execution_notes]
    P --> Q[保留is_executed=false]
    O --> R[返回策略列表]
    Q --> R
```

---

#### 3.2.8 费用配置与预估流程

```mermaid
flowchart TD
    A[进入账户设置] --> B[点击交易费用配置]
    B --> C[填写费用配置]
    C --> D[佣金率、最低佣金]
    D --> E[印花税率、过户费率]
    E --> F[其他费用]
    F --> G[保存到fee_config]
    G --> H[用户计划交易]
    H --> I[点击费用预估]
    I --> J[输入交易信息]
    J --> K[交易类型、数量、价格]
    K --> L[读取fee_config]
    L --> M[计算佣金]
    M --> N{买入or卖出}
    N -->|买入| O[总费用=佣金+过户费+其他]
    N -->|卖出| P[总费用=佣金+印花税+过户费+其他]
    O --> Q[显示费用明细]
    P --> Q
    Q --> R[总成本或总收入]
    R --> S[用户决定是否交易]
```

---

### 3.3 关键时序图

#### 3.3.1 AI分析请求时序图

```mermaid
sequenceDiagram
    actor User as 用户
    participant FE as 前端
    participant API as 后端API
    participant DB as 数据库
    participant MCP as MCP服务
    participant Claude as Claude API

    User->>FE: 点击"AI分析持仓"
    FE->>API: POST /api/ai/analyze/portfolio
    API->>DB: 查询账户资金信息
    DB-->>API: 返回资金数据
    API->>DB: 查询持仓列表
    DB-->>API: 返回持仓数据

    loop 每只持仓股票
        API->>MCP: 获取最新价格和公司信息
        MCP-->>API: 返回股票数据
    end

    API->>API: 构建AI Prompt
    API->>Claude: 调用Claude API
    Claude-->>API: 返回分析结果

    API->>DB: 保存策略到ai_strategies
    API->>DB: 扣除tokens
    DB-->>API: 确认保存

    API-->>FE: 返回分析结果
    FE-->>User: 显示分析结果
```

---

#### 3.3.2 交易录入与更新时序图

```mermaid
sequenceDiagram
    actor User as 用户
    participant FE as 前端
    participant API as 后端API
    participant DB as 数据库
    participant FeeCalc as 费用计算服务

    User->>FE: 填写交易信息
    FE->>API: POST /api/accounts/1/trades
    API->>DB: 查询账户fee_config
    DB-->>API: 返回费用配置

    API->>FeeCalc: 计算交易费用
    FeeCalc-->>API: 返回费用明细

    API->>DB: 开始事务
    API->>DB: 保存trade_records

    alt 买入
        API->>DB: 更新holdings（增加数量、更新成本）
        API->>DB: 减少账户流动资金
        API->>DB: 增加账户已投资金额
    else 卖出
        API->>DB: 更新holdings（减少数量）
        API->>DB: 计算已实现盈亏
        API->>DB: 增加账户流动资金
        API->>DB: 减少账户已投资金额
    end

    API->>DB: 记录资金变动account_fund_records
    API->>DB: 提交事务

    API-->>FE: 返回交易结果
    FE-->>User: 显示交易成功
```

---

### 3.4 状态机图

#### 3.4.1 AI策略状态流转

```mermaid
stateDiagram-v2
    [*] --> 策略生成
    策略生成 --> 待执行: 保存策略
    待执行 --> 已执行: 用户执行交易
    待执行 --> 已过期: 价格不再满足条件
    已执行 --> 盈利: 策略评估
    已执行 --> 亏损: 策略评估
    已过期 --> [*]
    盈利 --> [*]
    亏损 --> [*]

    note right of 策略生成
        AI分析完成
        tokens已扣除
    end note

    note right of 待执行
        is_executed = false
        等待用户操作
    end note

    note right of 已执行
        is_executed = true
        记录executed_at
    end note
```

---

#### 3.4.2 交易记录状态流转

```mermaid
stateDiagram-v2
    [*] --> 待录入
    待录入 --> 已提交: 用户提交
    已提交 --> 费用计算中: 系统处理
    费用计算中 --> 已保存: 费用计算完成
    已保存 --> 持仓已更新: 更新持仓
    持仓已更新 --> 资金已更新: 更新账户资金
    资金已更新 --> [*]

    已提交 --> 失败: 验证失败
    费用计算中 --> 失败: 计算错误
    失败 --> 待录入: 用户重新填写
```

---

### 3.5 数据流图

#### 3.5.1 持仓盈亏计算数据流

```mermaid
graph LR
    A[持仓数据] --> B[avg_cost × quantity]
    C[MCP价格服务] --> D[current_price]
    D --> E[current_price × quantity]
    B --> F[总成本]
    E --> G[当前市值]
    F --> H[未实现盈亏计算]
    G --> H
    H --> I[盈亏金额]
    H --> J[盈亏比例]
    I --> K[前端展示]
    J --> K
```

---

#### 3.5.2 账户资金流动数据流

```mermaid
graph TD
    A[总资金] --> B[已投资金额]
    A --> C[流动资金]
    A --> D[冻结资金]

    B --> E[所有持仓市值之和]
    E --> F[持仓1市值]
    E --> G[持仓2市值]
    E --> H[持仓N市值]

    I[买入交易] --> J[流动资金减少]
    J --> C
    I --> K[已投资金额增加]
    K --> B

    L[卖出交易] --> M[流动资金增加]
    M --> C
    L --> N[已投资金额减少]
    N --> B

    O[入金] --> P[流动资金增加]
    P --> C
    P --> Q[总资金增加]
    Q --> A

    R[出金] --> S[流动资金减少]
    S --> C
    S --> T[总资金减少]
    T --> A
```

---

