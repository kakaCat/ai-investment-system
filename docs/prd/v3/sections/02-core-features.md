# PRD v3 — AI驱动的个人投资管理与复盘系统

**版本**: v3.2
**状态**: 待评审
**日期**: 2025-01-17
**范围**: 多账户投资管理、AI策略生成、策略复盘、资金流动性管理、事件分析与追踪、AI决策流程系统

**v3.2 更新**:
- ✨ 新增AI决策流程系统（2.11章节）
  - 每日AI分析流程（持仓+关注股票，可选择参与）
  - AI股票推荐（详细购买策略：价格区间、仓位配置、时机把握）
  - 每日复盘总结（明日/未来预测）
  - 用户股票评价系统（看好/不看好原因、持有逻辑）

**v3.1 更新**:
- ✨ 新增完整的事件分析与追踪体系（2.9章节）
  - 四大类事件（政策/公司/市场/行业）、16种子类型
  - AI事件影响分析与预测
  - 事件时间线与可视化
  - 事件与持仓/策略的深度集成
  - 定时任务与智能提醒

---
## 2. 核心功能需求

### 2.1 用户与认证

#### 2.1.1 用户注册与登录
- 邮箱注册
- 用户名/邮箱 + 密码登录
- JWT Token认证

#### 2.1.2 AI Token管理
- **Token套餐**：用户购买AI调用额度
  - 基础套餐：10万tokens（约100次分析）
  - 标准套餐：50万tokens（约500次分析）
  - 高级套餐：200万tokens（约2000次分析）
- **Token消耗追踪**：
  - 每次AI调用记录消耗量
  - 实时显示剩余额度
  - 余额不足时提醒充值
- **消耗明细**：
  - 分析类型、消耗量、时间
  - 按日/周/月统计

---

### 2.2 账户管理

#### 2.2.1 账户基本信息
每个账户包含：
- **账户名称**：华泰证券、中信证券等
- **券商名称**：券商标识
- **账号后四位**：用于区分
- **总资金**：该账户投入的总资金（如30万）
- **已投资金额**：当前持仓市值
- **流动资金**：可用于新建仓或加仓的资金
- **冻结资金**：待交割资金（可选）
- **账户状态**：活跃、归档

#### 2.2.1.1 交易费用配置
不同券商、不同市场的交易费用不同，需为每个账户配置：

**佣金（Commission）**
- **佣金率**（commission_rate）：按交易金额的百分比
  - A股典型范围：0.02% - 0.03%（万2 - 万3）
  - 港股典型范围：0.03% - 0.25%
  - 美股典型范围：固定费用（如$0.99/笔）或按股数
- **最低佣金**（min_commission）：单笔最低收费
  - A股典型：5元
  - 港股典型：100港元
  - 美股典型：$0.99

**印花税（Stamp Duty）** - 仅卖出时收取
- **A股**：0.1%（千分之一）- 国家规定，固定
- **港股**：0.13%（千分之1.3）- 固定
- **美股**：无

**过户费（Transfer Fee）**
- **A股**：0.001%（万分之一）- 固定
- **港股**：按股数收取（如每股HKD 0.002）
- **美股**：无（或极低）

**其他费用**
- **证管费**：A股0.002%（买卖双向）
- **证券交易经手费**：A股0.00487%（买卖双向）
- **平台使用费**：部分券商收取（可选）

**费用配置示例**：
```json
// 华泰证券A股账户
{
  "commission_rate": 0.0003,      // 万3
  "min_commission": 5.0,          // 最低5元
  "stamp_duty_rate": 0.001,       // 印花税0.1%（卖出）
  "transfer_fee_rate": 0.00001,   // 过户费0.001%
  "other_fees": {
    "regulatory_fee": 0.00002,    // 证管费0.002%
    "handling_fee": 0.0000487     // 经手费0.00487%
  }
}

// 富途证券港股账户
{
  "commission_rate": 0.0003,      // 0.03%
  "min_commission": 15.0,         // 最低15港元
  "stamp_duty_rate": 0.0013,      // 印花税0.13%（卖出）
  "other_fees": {
    "transaction_levy": 0.000027, // 交易征费0.0027%
    "trading_fee": 0.00005,       // 交易费0.005%
    "settlement_fee": 0.00002     // 结算费0.002%
  }
}
```

**费用计算逻辑**：
```
买入总成本 = 成交金额 + 佣金 + 其他费用
卖出净收入 = 成交金额 - 佣金 - 印花税 - 过户费 - 其他费用

佣金 = max(成交金额 × 佣金率, 最低佣金)

实际收益 = 卖出净收入 - 买入总成本
```

#### 2.2.2 资金计算逻辑
```
总资金 = 已投资金额 + 流动资金 + 冻结资金
已投资金额 = Σ(持仓股票市值)
流动资金 = 总资金 - 已投资金额 - 冻结资金
```

#### 2.2.3 资金管理功能
- **充值/提现记录**：记录资金变动
- **资金流水**：所有资金变动历史
- **资金分配建议**：AI根据流动资金建议操作
  - 流动资金充足（>30%）→ 建议新建仓或加仓
  - 流动资金适中（10-30%）→ 建议等待机会
  - 流动资金不足（<10%）→ 建议持有或减仓

#### 2.2.4 账户详情页面

**需求编号**: R-ACC-005

**页面布局**：

账户详情页包含以下核心区域：

1. **账户概况卡片**
   - 总资金、可用资金、已投资、总盈亏
   - 今日盈亏、累计盈亏、持仓数量、交易次数
   - 最后更新时间

2. **Tab导航**
   - [我的股票] - 默认Tab
   - [资金流水] - 资金变动记录
   - [交易记录] - 买卖交易历史
   - [绩效分析] - 收益曲线、风险指标

3. **我的股票Tab** - 双列表设计 ⭐

**3.1 持仓股票列表**

显示该账户实际持有的股票：

```
┌─ 持仓股票 (3只) ────────────────────────────────┐
│                                                  │
│ 代码    名称      数量   成本价   现价   盈亏    │
│ ──────────────────────────────────────────────  │
│ 00700  腾讯控股   150  ¥620.00  ¥650.00  +4.8% │
│ 600600 青岛啤酒  1600   ¥78.40   ¥62.50 -20.3% │
│ 002594 比亚迪     100  ¥245.00  ¥280.00 +14.3% │
│                                                  │
│ 持仓市值: ¥145,000  |  总盈亏: +¥3,950 (+2.8%) │
└──────────────────────────────────────────────┘
```

**字段说明**：
- **代码/名称**：股票标识
- **数量**：持仓股数
- **成本价**：平均持仓成本
- **现价**：最新价格（实时/延时）
- **盈亏**：浮动盈亏（金额+百分比）
- **操作**：[详情] [记录交易] [AI分析]

**展开详情**（点击▼）：
- 买入历史记录
- 成本分析（平均成本、当前价格、持仓盈亏）
- 账户占比
- 快速操作按钮

**3.2 关注股票列表**

显示该账户关注但未持有的股票：

```
┌─ 关注股票 (5只) ────────────────────────────────┐
│                                                  │
│ 代码    名称      现价    目标价  关注度  操作  │
│ ──────────────────────────────────────────────  │
│ 600519 贵州茅台  ¥1850  ¥1700   ⭐⭐⭐  [建仓] │
│ 000858 五粮液    ¥185   ¥180    ⭐⭐⭐  [建仓] │
│ 601318 中国平安  ¥58    ¥55     ⭐⭐    [观望] │
│ 300750 宁德时代  ¥210   ¥200    ⭐⭐⭐  [建仓] │
│ 002475 立讯精密  ¥35    ¥33     ⭐⭐    [观望] │
│                                                  │
│ [添加关注]                                       │
└──────────────────────────────────────────────┘
```

**字段说明**：
- **代码/名称**：股票标识
- **现价**：最新价格
- **目标价**：用户设定的期望买入价
- **关注度**：用户评级（⭐-⭐⭐⭐，对应Low-Medium-High）
- **AI建议**：
  - [建仓]：AI建议可以买入
  - [观望]：AI建议等待更好时机
  - [风险]：AI提示存在风险
- **操作**：[详情] [记录建仓] [移除关注]

**列表排序**：
- 默认按关注度排序（⭐⭐⭐ > ⭐⭐ > ⭐）
- 支持按现价偏离度排序（当前价 vs 目标价）
- 支持按AI建议排序

**4. 资金流水Tab**

显示该账户的所有资金变动记录：
- 日期、类型（买入/卖出/充值/转账/分红/手续费）
- 摘要说明、金额（收入/支出）、账户余额
- 支持筛选：按类型、按时间范围、按金额范围

**5. 交易记录Tab**

显示该账户的所有交易记录：
- 日期、操作类型（买入/卖出）、股票代码/名称
- 数量、价格、金额、盈亏（仅卖出显示）
- 支持筛选：按操作类型、按股票、按时间范围

**6. 绩效分析Tab**

显示该账户的收益和风险指标：
- **收益曲线**：净值走势图、对比基准指数
- **收益明细**：累计盈亏、浮动盈亏、已实现盈亏、分红收入
- **风险指标**：最大回撤、夏普比率、胜率、盈亏比
- **交易统计**：总交易次数、盈利/亏损交易占比、平均持仓周期、换手率

**交互说明**：

1. **持仓与关注分离**：
   - 持仓列表在上，关注列表在下
   - 两个列表独立滚动
   - 视觉上用分隔线或卡片区分

2. **从关注到持仓**：
   - 在关注列表点击[记录建仓]
   - 录入买入交易后，该股票自动移至持仓列表
   - 关注列表中移除该股票（或标记为"已建仓"状态）

3. **从持仓到关注**：
   - 当持仓清空（全部卖出）时
   - 提示"是否继续关注该股票？"
   - 选择"是"则移至关注列表，"否"则移除

4. **快速操作**：
   - 持仓列表：[查看详情] [记录卖出] [AI分析]
   - 关注列表：[查看详情] [记录建仓] [移除关注]

**数据来源**：
- 持仓数据：`holdings` 表
- 关注数据：`watchlist` 表
- 价格数据：`price_snapshots` 表（实时刷新）

**参考原型**：
- [账户详情页原型图](../../../design/ui/wireframes/02-account-detail.md)

---

### 2.3 股票信息库

#### 2.3.1 全市场支持
- **A股**：沪深交易所（代码格式：000001, 600000等）
- **港股**：港交所（代码格式：00700, 09988等）
- **美股**：纳斯达克、纽交所（代码格式：AAPL, TSLA等）
- **其他市场**：可扩展（日本、欧洲等）

#### 2.3.2 股票基础信息
- **基本信息**：代码、名称、市场、交易所、行业、市值
- **交易规则**：
  - **最小交易单位**（lot_size）：
    - A股：100股（1手）
    - 港股：按股票不同（腾讯=100股，比亚迪=500股）
    - 美股：1股
  - **价格涨跌幅限制**：
    - A股：±10%（ST股±5%，科创板/创业板±20%）
    - 港股：无限制
    - 美股：无限制
  - **交易时间**：开盘/收盘时间
  - **货币**：CNY/HKD/USD

#### 2.3.3 公司信息
- 主营业务
- 核心竞争力
- 主要风险
- 财务指标（市盈率、ROE、负债率等）

#### 2.3.4 数据来源
- **MCP服务**：通过Model Context Protocol获取
  - akshare MCP：A股数据
  - 港股/美股MCP：港股、美股数据
  - 第三方MCP服务器（可配置）

#### 2.3.5 股票查询与搜索

**需求编号**: R-STK-001 ~ R-STK-005

**搜索方式**：
1. **代码搜索**：
   - 输入股票代码（支持部分匹配）
   - 示例：输入"600"显示所有600开头的股票
   - 支持A股、港股、美股代码格式

2. **名称搜索**：
   - 输入股票名称（支持模糊搜索）
   - 示例：输入"腾讯"、"tencent"、"tx"
   - 支持中文、英文、拼音首字母

3. **行业筛选**：
   - 按行业分类浏览
   - 示例：消费、科技、金融、医药等

**数据获取流程**：
```
用户搜索股票
    ↓
检查本地缓存（stocks表）
    ↓
如果存在 → 返回结果
    ↓
如果不存在 → 调用MCP服务
    ↓
从Tushare/AkShare获取股票信息
    ↓
保存到stocks表（缓存）
    ↓
返回结果给用户
```

**自动获取信息**：
- 用户添加股票到持仓/关注列表时
- 系统自动通过MCP获取以下信息：
  - 股票名称、市场、交易所
  - 行业分类、货币
  - 最小交易单位（lot_size）
  - 交易时间规则
- 保存到 `stocks` 表作为缓存

**搜索响应速度**：
- 本地缓存：< 100ms
- MCP查询：< 2s（首次查询）
- 缓存有效期：30天（定期更新基本信息）

---

### 2.4 持仓管理

#### 2.4.1 持仓信息
- **股票代码、名称、市场**
- **持仓数量**（quantity）
- **可用数量**（available_quantity）：可卖出数量
- **平均成本**（avg_cost）：加权平均成本
- **当前价格**（current_price）：最新价格
- **持仓市值**：quantity × current_price
- **未实现盈亏**：(current_price - avg_cost) × quantity
- **盈亏比例**：未实现盈亏 / (avg_cost × quantity)
- **持仓占比**：持仓市值 / 账户总资金
- **用户标签**：核心持仓、长期持有、短线等
- **AI标签**：长期持有、注意操作、建议减仓等
- **持仓状态**：持有中、已清仓

#### 2.4.2 持仓操作
- **添加持仓**：手动输入或导入
- **更新持仓**：调整数量、成本
- **刷新价格**：通过MCP获取最新价格（手动触发）
- **查看持仓**：列表、详情、分组
- **持仓导入**：
  - CSV批量导入
  - OCR图片识别（Phase 2）

#### 2.4.3 关注列表
- **关注股票**：未持有但关注的股票
- **目标价位**：期望买入价格
- **关注理由**：备注说明
- **状态**：关注中、已建仓

---

### 2.5 交易记录

#### 2.5.1 交易类型
- **买入**（buy）
- **卖出**（sell）
- **分红**（dividend）
- **送股/转增**（stock_dividend）
- **拆股/并股**（split）

#### 2.5.2 交易信息
- 交易时间、股票代码、交易类型
- 数量、价格、金额
- 手续费、印花税、过户费
- 备注说明
- 幂等键（防重复）

#### 2.5.3 交易记录功能
- **新增交易**：手动录入
  - 用户输入：股票代码、数量、价格
  - 系统自动计算费用（基于账户的fee_config）：
    ```
    成交金额 = 数量 × 价格
    佣金 = max(成交金额 × 佣金率, 最低佣金)
    印花税 = 成交金额 × 印花税率（仅卖出）
    过户费 = 成交金额 × 过户费率
    其他费用 = 成交金额 × (证管费率 + 经手费率)
    总费用 = 佣金 + 印花税 + 过户费 + 其他费用

    买入实际成本 = 成交金额 + 总费用
    卖出实际收入 = 成交金额 - 总费用
    ```
  - 用户可手动调整费用（如券商有优惠）

- **批量导入**：从券商导出的交易记录
  - 支持CSV格式
  - 自动解析交易类型、数量、价格、费用

- **交易历史**：按时间、股票、类型查询

- **已实现盈亏计算**：卖出时计算盈亏
  - 采用先进先出（FIFO）原则
  - 已实现盈亏 = 卖出净收入 - 对应批次的买入成本
  - 考虑所有交易费用

- **费用统计**：
  - 按月/年统计总交易费用
  - 分析不同券商的费用差异
  - 优化交易策略降低费用

---

### 2.6 AI策略生成

#### 2.6.1 整体持仓分析
**触发方式**：用户点击"分析持仓"

**AI分析内容**：
```
【账户概览】
- 总资金：30万
- 已投资：14.5万（48.3%）
- 流动资金：15.5万（51.7%）
- 未实现盈亏：+0.7万（+4.8%）

【持仓明细分析】
对每只股票（示例：青岛啤酒）：
  - 当前价：65.8元，成本：78.4元，盈亏：-16.1%
  - 持仓占比：7.3%（偏高）
  - AI操作建议：
    * 持有：等待消费复苏
    * 加仓：62-64元区间加仓500股
    * 止损：跌破58元止损
  - 理由：消费行业底部，品牌价值稳固

【资金运用建议】
- 流动资金15.5万充足（>50%）
- 建议操作：
  1. 青岛啤酒回调至62-64元可加仓（使用3万）
  2. 关注腾讯控股620-630港元（使用6万）
  3. 预留6.5万等待其他机会

【组合层面建议】
- 行业配置：消费50%，科技20%，金融15%，其他15%
- 风险评估：单股集中度偏高（青岛啤酒7.3%）
- 再平衡建议：分散到其他消费股

【风险提示】
- 青岛啤酒浮亏较大，需关注基本面
- 市场波动加大，控制仓位
```

#### 2.6.2 单股深度分析
**触发方式**：点击某只股票 → "AI深度分析"

**AI分析内容**：
```
【我的持仓】
- 青岛啤酒（600600）
- 持有：1600股，成本：78.4元，现价：65.8元
- 盈亏：-20,169元（-16.1%）

【公司基本面】（从MCP获取）
- 主营业务：啤酒生产与销售
- 核心竞争力：品牌、渠道
- 最新财务：Q3营收+5%，净利润-3%
- 行业地位：行业第二，市占率15%

【AI深度分析】
- 基本面评分：75/100（中等）
  * 营收稳健，但净利润承压
  * 高端化转型进展缓慢
  * 原材料成本上升
- 技术面分析：
  * 趋势：下降趋势，接近支撑位
  * 支撑位：65元、60元、55元
  * 阻力位：70元、75元、80元
- 估值分析：
  * 市盈率：22倍（行业平均25倍）
  * 市净率：2.8倍（合理）
  * 股息率：2.5%（偏低）

【投资建议】
- 当前阶段：持有等待，不建议加仓
- 具体操作：
  * 加仓时机：跌破60元且基本面改善
  * 止盈时机：回升至85元
  * 止损位：52元
- 长期观点：中性
  * 看好：品牌价值、行业集中度提升
  * 担忧：高端化进展慢、成本压力

【基于流动资金的建议】
- 当前流动资金：15.5万（充足）
- 是否建议加仓：不建议（基本面未改善）
- 建议用途：等待更好标的或青岛啤酒跌至55元

【具体交易计划】

买入策略：
| 买入点 | 买入数量 | 买入条件 | 触发事件 |
|--------|----------|----------|----------|
| 62-64元 | 300股 | 价格回落至62-64元区间 | 基本面改善，消费数据回暖 |
| 58-60元 | 500股 | 价格回落至58-60元区间 | 技术支撑位，估值低估 |
| 55-58元 | 500股 | 价格回落至55-58元区间 | 深度低估，基本面未恶化 |

卖出策略：
| 卖出点 | 卖出数量 | 卖出条件 | 触发事件 |
|--------|----------|----------|----------|
| 75-78元 | 500股 | 价格达到75-78元区间 | 回本区域，减仓降低风险 |
| 82-85元 | 600股 | 价格达到82-85元区间 | 估值合理偏高，锁定利润 |
| 90-95元 | 500股 | 价格达到90-95元区间 | 估值泡沫化，全部清仓 |

风险控制：
| 止损位 | 操作 | 触发条件 |
|--------|------|----------|
| 52元 | 清仓 | 基本面严重恶化或行业重大利空 |
| 跌破50元 | 紧急加仓 | 非理性下跌，价值严重低估 |
```

#### 2.6.3 投资机会发现
**触发方式**：用户点击"发现投资机会"

**用户输入**：
- 行业：科技、消费、医疗等（可选）
- 风险偏好：保守、稳健、激进
- 市值范围：大盘、中盘、小盘
- 投资期限：短期、中期、长期
- 最大投资金额：基于当前流动资金

**AI推荐输出**：
```
基于你的账户情况：
- 流动资金：15.5万
- 风险偏好：稳健
- 投资期限：中长期

推荐5个投资机会：

1. 【腾讯控股 (00700)】- 评分：90/100
   - 推荐理由：互联网龙头，估值合理，业绩稳健
   - 当前价：650港元
   - 目标价：750港元（+15%）
   - 建议仓位：6万港元（约100股）
   - 风险等级：中
   - 最小交易：100股

2. 【中国神华 (601088)】- 评分：85/100
   - 推荐理由：高股息（8%），能源安全受益
   - 当前价：43元
   - 目标价：50元（+16%）
   - 建议仓位：4万元（约900股）
   - 风险等级：低
   - 最小交易：100股

3. 【宁德时代 (300750)】- 评分：82/100
   - 推荐理由：新能源龙头，技术领先
   - 当前价：385元
   - 目标价：450元（+17%）
   - 建议仓位：3万元（约77股）
   - 风险等级：中高
   - 最小交易：100股（需投资38,500元）

...

【资金分配建议】
- 总流动资金：15.5万
- 建议分配：
  * 腾讯控股：6万（38.7%）
  * 中国神华：4万（25.8%）
  * 宁德时代：3万（19.4%）
  * 预留资金：2.5万（16.1%）
```

#### 2.6.4 AI Token消耗
- 快速分析（整体持仓）：约2000 tokens
- 深度分析（单股）：约5000 tokens
- 投资机会发现：约3000 tokens
- 实时显示本次消耗和剩余额度

---

### 2.7 策略记录与复盘

#### 2.7.1 策略记录
**每次AI分析自动记录：**
- 策略生成时间
- 策略类型（整体分析、单股分析、机会发现）
- 股票代码（如果是单股分析）
- AI建议内容（JSON格式存储）
  - 操作建议：持有/加仓/减仓/清仓
  - 目标价位
  - 止损位
  - 建议理由
- 当时的持仓情况快照
  - 持仓数量、成本、当前价、盈亏
- 当时的价格快照
  - 股票价格、成交量
- 当时的资金情况
  - 流动资金、已投资金额

#### 2.7.2 策略回顾看板
**功能**：查看历史AI策略，对比实际执行情况

**视图1：策略列表**
```
| 日期 | 股票 | AI建议 | 建议价位 | 当时价格 | 当前价格 | 是否执行 | 执行效果 |
|------|------|--------|---------|----------|----------|----------|----------|
| 2025-11-01 | 青岛啤酒 | 加仓500股 | 62-64元 | 65.8元 | 66.5元 | 未执行 | N/A |
| 2025-11-02 | 腾讯控股 | 买入100股 | 620-630港元 | 632港元 | 650港元 | 已执行 | +2.8% |
| 2025-11-03 | 中国神华 | 持有 | - | 43元 | 42.5元 | 已执行 | -1.2% |
```

**视图2：策略详情**
```
【策略详情】
- 生成时间：2025-11-01 15:00
- 股票：青岛啤酒（600600）
- 类型：单股深度分析

【AI建议】
- 操作：加仓500股
- 目标价位：62-64元
- 理由：消费底部，估值修复空间大
- 止损位：58元

【当时情况】
- 股票价格：65.8元
- 持仓：1600股 @ 78.4元
- 盈亏：-16.1%
- 流动资金：15.5万

【执行情况】
- 是否执行：未执行
- 未执行原因：价格未到目标区间

【策略效果评估】
- 当前价格：66.5元
- 如果执行的收益：+1.1%（假设在63元买入）
- 实际结果：未操作
```

#### 2.7.3 复盘功能
**周度/月度复盘：**

**1. 策略执行率**
- 总策略数：20条
- 已执行：12条（60%）
- 未执行：8条（40%）
  - 价格未到：5条
  - 流动资金不足：2条
  - 手动放弃：1条

**2. 策略准确率**
- 已执行策略中：
  - 盈利：8条（66.7%）
  - 亏损：4条（33.3%）
- 平均收益率：+3.2%

**3. 未执行策略分析**
- 如果执行的收益：
  - 青岛啤酒加仓未执行：错过+1.1%
  - 宁德时代建仓未执行：错过+5.2%

**4. AI建议质量评估**
```
| 指标 | 数值 |
|------|------|
| 总建议数 | 20 |
| 盈利建议 | 13（65%） |
| 亏损建议 | 7（35%） |
| 平均预测准确率 | 68% |
| 最佳建议 | 宁德时代买入（+12%） |
| 最差建议 | 万科A加仓（-8%） |
```

**5. 资金利用率**
- 平均流动资金占比：45%
- 最高持仓占比：70%
- 最低持仓占比：30%
- 建议：保持40-60%持仓

**6. 改进建议**
- 执行纪律：严格按AI建议价位操作
- 风险控制：设置止损并严格执行
- 仓位管理：避免单股占比过高

---

### 2.8 价格管理

**需求编号**: R-PRC-001 ~ R-PRC-004

#### 2.8.1 价格获取方式
- **手动刷新**：用户点击"刷新价格"按钮
  - 可单个股票刷新
  - 可全部持仓刷新
  - 可按账户刷新
- **批量更新**：一键更新所有持仓价格
- **数据来源**：通过MCP服务获取实时行情

#### 2.8.2 MCP 数据集成详细说明

**数据源配置**：

| 数据源 | 用途 | 优先级 | API要求 | 特点 |
|--------|------|--------|---------|------|
| **Tushare Pro** | A股、港股、美股行情 | 1️⃣ 主要数据源 | 需要Token | 数据质量高，需积分 |
| **AkShare** | A股、港股行情 | 2️⃣ 备选数据源 | 免费，无需Token | 通过MCP封装 |
| **新浪财经API** | A股实时行情 | 3️⃣ 直接调用 | 免费，无需Token | 实时性好，稳定 |
| **雪球API** | A股、港股、美股 | 4️⃣ 直接调用 | 免费，无需Token | 数据丰富，社区数据 |
| **东方财富API** | A股实时行情 | 5️⃣ 直接调用 | 免费，无需Token | 备选方案 |

**MCP 服务器配置**：
```json
{
  "mcpServers": {
    "tushare": {
      "command": "uvx",
      "args": ["mcp-server-tushare"],
      "env": {
        "TUSHARE_TOKEN": "your_token_here"
      }
    },
    "akshare": {
      "command": "uvx",
      "args": ["mcp-server-akshare"]
    }
  }
}
```

**数据获取流程**：

1. **实时行情获取**：
   ```
   用户点击刷新
       ↓
   收集需要更新的股票代码列表
       ↓
   优先使用 Tushare Pro MCP
       ↓
   如果失败/超限 → 降级到 AkShare MCP
       ↓
   批量获取最新价格、成交量、涨跌幅
       ↓
   保存到 price_snapshots 表
       ↓
   更新前端显示
   ```

2. **数据缓存策略**：
   - **交易时间内**：缓存 30 秒（避免频繁调用）
   - **非交易时间**：缓存 5 分钟
   - **历史数据**：永久缓存（不更新）

3. **API 调用频率控制**：
   - Tushare 免费账户：每分钟 200 次
   - 超出限制时自动降级到 AkShare
   - 用户侧限制：单次最多刷新 50 只股票

**获取的价格数据**：
- **实时价格** (price)：最新成交价
- **成交量** (volume)：当日成交量
- **涨跌幅** (change_percent)：相对昨收盘的涨跌百分比
- **开盘价/最高价/最低价**（可选，按需获取）
- **昨收盘价** (pre_close)：用于计算涨跌幅
- **快照时间** (snapshot_time)：价格获取时间

**数据来源标识**：
- 每次价格更新记录 `source` 字段：
  - `"MCP:tushare"` - 来自 Tushare
  - `"MCP:akshare"` - 来自 AkShare
  - `"API:sina"` - 来自新浪财经
  - `"API:xueqiu"` - 来自雪球
  - `"API:eastmoney"` - 来自东方财富
  - `"manual"` - 用户手动输入

#### 2.8.2.1 直接 API 调用方案

**方案一：新浪财经 API** ⭐ 推荐

**优势**：
- 完全免费，无需注册
- 实时性好（延迟 < 1秒）
- 接口稳定，长期可用
- 支持批量查询（一次最多100只）

**API 接口**：
```
A股实时行情：
https://hq.sinajs.cn/list={股票代码}

示例：
https://hq.sinajs.cn/list=sh600519  (贵州茅台)
https://hq.sinajs.cn/list=sz000001  (平安银行)
https://hq.sinajs.cn/list=sh600519,sz000001  (批量查询)
```

**代码格式转换**：
- A股：600519 → sh600519（沪市）、000001 → sz000001（深市）
- 规则：60开头 → sh前缀，00/30开头 → sz前缀

**返回数据格式**：
```javascript
var hq_str_sh600519="贵州茅台,1680.00,1675.00,1682.50,1685.00,1678.00,1682.50,1683.00,12580,2115246400,100,1682.00,200,1681.50,300,1681.00,500,1680.50,400,1680.00,100,1683.00,200,1683.50,300,1684.00,400,1684.50,500,1685.00,2025-01-15,15:00:03,00,";

字段说明（逗号分隔）：
0: 股票名称
1: 今开
2: 昨收
3: 现价
4: 最高
5: 最低
6: 买一价
7: 卖一价
8: 成交量（股）
9: 成交额（元）
10-29: 买卖五档
30: 日期
31: 时间
```

**后端解析示例**：
```python
import httpx
import re

async def get_sina_quote(symbol: str):
    # 转换代码格式
    if symbol.startswith('6'):
        code = f"sh{symbol}"
    elif symbol.startswith(('0', '3')):
        code = f"sz{symbol}"
    else:
        raise ValueError("Invalid A-share symbol")

    url = f"https://hq.sinajs.cn/list={code}"
    async with httpx.AsyncClient() as client:
        resp = await client.get(url)
        data = resp.text

    # 解析数据
    match = re.search(r'"(.+)"', data)
    if match:
        fields = match.group(1).split(',')
        return {
            "symbol": symbol,
            "name": fields[0],
            "price": float(fields[3]),
            "open": float(fields[1]),
            "close_yesterday": float(fields[2]),
            "high": float(fields[4]),
            "low": float(fields[5]),
            "volume": int(fields[8]),
            "amount": float(fields[9]),
            "change_percent": ((float(fields[3]) - float(fields[2])) / float(fields[2])) * 100,
            "snapshot_time": f"{fields[30]} {fields[31]}",
            "source": "API:sina"
        }
```

---

**方案二：雪球 API**

**优势**：
- 数据维度丰富（包含社区情绪数据）
- 支持A股、港股、美股
- 提供分时数据

**API 接口**：
```
实时行情：
https://stock.xueqiu.com/v5/stock/quote.json?symbol={代码}&extend=detail

示例：
A股：https://stock.xueqiu.com/v5/stock/quote.json?symbol=SH600519
港股：https://stock.xueqiu.com/v5/stock/quote.json?symbol=00700
美股：https://stock.xueqiu.com/v5/stock/quote.json?symbol=AAPL
```

**代码格式**：
- A股：SH600519（沪市）、SZ000001（深市）
- 港股：00700（腾讯）、09988（阿里）
- 美股：AAPL、TSLA 等

**请求头要求**：
```python
headers = {
    "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36",
    "Referer": "https://xueqiu.com/"
}
```

**返回数据示例**：
```json
{
  "data": {
    "quote": {
      "symbol": "SH600519",
      "name": "贵州茅台",
      "current": 1682.50,
      "percent": 0.45,
      "chg": 7.50,
      "volume": 1258000,
      "amount": 2115246400,
      "high": 1685.00,
      "low": 1678.00,
      "open": 1680.00,
      "last_close": 1675.00,
      "timestamp": 1705305603000
    }
  }
}
```

---

**方案三：东方财富 API** （备选）

**API 接口**：
```
实时行情：
https://push2.eastmoney.com/api/qt/stock/get?secid={市场代码}.{股票代码}&fields=f43,f44,f45,f46,f47,f48,f49,f50,f51,f52

示例：
https://push2.eastmoney.com/api/qt/stock/get?secid=1.600519&fields=f43,f44,f45,f46,f47,f48,f49,f50,f51,f52

市场代码：
- 1：沪市
- 0：深市
- 116：港股
- 105：美股
```

**字段说明**：
- f43: 最新价
- f44: 最高价
- f45: 最低价
- f46: 开盘价
- f47: 成交量
- f48: 成交额
- f49: 涨跌幅
- f50: 涨跌额
- f51: 量比
- f52: 换手率

---

**数据源降级策略**：

```
优先级1: Tushare Pro (如已配置Token)
    ↓ 失败/超限
优先级2: 新浪财经 API (实时性好)
    ↓ 失败
优先级3: 雪球 API (数据维度丰富)
    ↓ 失败
优先级4: AkShare MCP (备选)
    ↓ 失败
优先级5: 东方财富 API (最后备选)
    ↓ 全部失败
返回错误，提示用户稍后重试
```

**多数据源并行验证**（可选策略）：
- 同时调用新浪 + 雪球
- 对比价格差异，取中位数
- 差异过大时记录异常日志

#### 2.8.3 历史价格与快照

**价格快照表** (`price_snapshots`)：
- 每次刷新保存一条记录
- 用于绘制价格走势图
- 支持查询历史某时刻的价格

**历史数据获取**（可选功能，P1）：
- 通过 MCP 获取日线级别历史数据
- 用于计算技术指标（MA、MACD等）
- 支持回测功能

#### 2.8.4 价格提醒

- **达到目标价提醒**：关注列表中设置的目标价
- **跌破止损位提醒**：持仓跌幅超过设定阈值
- **涨跌幅提醒**：单日涨跌超过 X%
- **提醒方式**：前端弹窗、系统通知（可选）

---

### 2.10 数据可视化

#### 2.10.1 仪表板
**总览卡片：**
- 所有账户汇总：
  - 总资金
  - 总市值
  - 未实现盈亏（金额 + 百分比）
  - 流动资金
  - 流动资金占比
- 今日盈亏
- 持仓股票数

**账户列表：**
| 账户名 | 总资金 | 已投资 | 流动资金 | 盈亏 | 操作 |
|--------|--------|--------|----------|------|------|
| 华泰证券 | 30万 | 14.5万 | 15.5万 | +4.8% | 查看 |
| 中信证券 | 20万 | 8万 | 12万 | +2.3% | 查看 |

**AI今日提醒：**
- 青岛啤酒接近加仓价位（当前65.8元，目标62-64元）
- 中国神华达到止盈位，建议减仓
- 腾讯控股建议买入（当前价格合理）

#### 2.10.2 持仓页面
**表格视图：**
| 股票 | 市场 | 现价 | 成本 | 数量 | 市值 | 盈亏 | 盈亏% | 占比 | AI建议 | 操作 |
|------|------|------|------|------|------|------|-------|------|--------|------|
| 青岛啤酒 | A股 | 65.8 | 78.4 | 1600 | 10.5万 | -2万 | -16.1% | 7.3% | 持有 | ... |
| 腾讯控股 | 港股 | 650 | 632 | 100 | 6.5万 | +1800 | +2.8% | 4.5% | 持有 | ... |

**图表视图：**
- 饼图：持仓占比、行业分布、市场分布
- 柱状图：盈亏排行
- 折线图：净值曲线（需历史数据）

#### 2.10.3 策略回顾看板
- 策略列表（表格）
- 策略详情（弹窗）
- 执行率图表（饼图）
- 准确率图表（柱状图）
- 收益曲线（折线图）

#### 2.10.4 复盘分析页面
- 周度/月度复盘报告
- 策略执行统计
- 资金利用率分析
- AI建议质量评估
- 改进建议

---

### 2.11 AI决策流程系统 ⭐ (v3.2 新增)

> **核心价值**：将AI从单次分析工具升级为持续决策助手，提供从早盘分析→盘中提醒→盘后复盘的全流程支持。

#### 2.11.1 系统概述

**设计理念**：
- **事件驱动 + 主动推荐**：基于事件分析（2.9）触发AI决策，同时支持用户主动触发
- **结构化 + 对话式**：AI输出结构化策略卡片，同时支持对话式追问
- **AI评估 + 用户评价**：AI提供客观分析，用户记录主观判断，双轨并行
- **单股分析 + 组合优化**：既支持个股深度分析，也支持整体仓位优化

**三大核心场景**：
1. **每日AI分析流程**：持仓+关注股票的批量AI分析（可选择参与股票）
2. **AI股票推荐**：AI主动推荐买入/卖出机会，附详细策略
3. **每日复盘总结**：盘后AI复盘 + 明日/未来预测

---

#### 2.11.2 场景一：每日AI分析流程

##### 2.11.2.1 触发机制

**自动触发**（可配置开关）：
- **开盘前（09:00）**：基于前夜事件和今日预披露信息
- **盘中实时（可选）**：重大事件发生时触发
- **收盘后（15:30）**：基于全天交易数据和盘后公告

**手动触发**：
- 仪表板"开始AI分析"按钮
- 单个股票详情页"刷新AI分析"
- 关注列表批量分析

##### 2.11.2.2 股票选择界面

**UI布局**：
```
┌─ 每日AI分析 ──────────────────────────────────┐
│ 参与分析的股票（默认全部）                      │
│                                                │
│ 持仓股票 (3支):                                 │
│ ☑️ 青岛啤酒 (600600)  A股  ¥65.8  -2.1%       │
│ ☑️ 腾讯控股 (00700)   港股 HK$368 +1.5%       │
│ ☑️ 宁德时代 (300750)  A股  ¥195.8 +2.3%       │
│                                                │
│ 关注股票 (5支):                                 │
│ ☑️ 茅台 (600519)      A股  ¥1650  -0.8%       │
│ ☐ 比亚迪 (002594)     A股  ¥215.6  +3.2%       │
│ ☐ 理想汽车 (02015)    港股 HK$102  +4.5%       │
│ ☐ 招商银行 (600036)   A股  ¥35.2   -1.2%       │
│ ☐ 万科A (000002)      A股  ¥8.95   +0.5%       │
│                                                │
│ [全选] [全不选] [仅持仓] [仅关注]              │
│                                                │
│ 预计消耗: ~800 tokens │ 剩余: 48,200 tokens   │
│                                                │
│           [取消]    [开始分析 🤖]              │
└────────────────────────────────────────────────┘
```

**功能要点**：
- 默认选中所有持仓股票
- 关注股票默认不选中（避免Token浪费）
- 显示实时价格和涨跌幅
- 预估Token消耗（单股约100-200 tokens）
- 快捷操作按钮（全选/仅持仓等）

##### 2.11.2.3 分析进度与结果展示

**分析进度条**：
```
┌─ AI分析中 ─────────────────────────────────────┐
│ ████████████████░░░░░░░░░░ 60% (3/5)          │
│                                                │
│ ✅ 青岛啤酒 - 分析完成                         │
│ ✅ 腾讯控股 - 分析完成                         │
│ ⏳ 宁德时代 - 分析中...                        │
│ ⏸️ 茅台 - 等待中                              │
│ ⏸️ 比亚迪 - 等待中                            │
│                                                │
│ 预计剩余时间: 约 30秒                          │
└────────────────────────────────────────────────┘
```

**结果卡片（单个股票）**：
```
┌─ 青岛啤酒 (600600) ────────────────────────────┐
│ A股 · 食品饮料 · 啤酒行业                       │
│                                                │
│ 当前价: ¥65.80  成本价: ¥78.40  盈亏: -16.1%  │
│                                                │
│ 📊 AI综合评分: 7.2/10                          │
│ ────────────────────────────────────────       │
│ 基本面: 8/10  技术面: 6/10  估值: 7/10         │
│                                                │
│ 🎯 AI建议: 持有，等待回调后加仓                │
│                                                │
│ 💡 核心观点:                                    │
│ • 基本面稳健，白酒消费复苏利好啤酒板块          │
│ • 当前估值合理（PE 18.5x，低于3年均值20x）     │
│ • 技术面短期超卖，MACD即将金叉                 │
│                                                │
│ 📋 建议操作策略:                                │
│ 🎯 加仓价位:                                    │
│   • 第一批: ¥62-64（回调5%左右），加仓30%      │
│   • 第二批: ¥58-60（回调10%），加仓50%         │
│ 💰 资金配置:                                    │
│   • 建议增持至组合10-12%（当前7.3%）           │
│   • 单笔加仓金额: 1-2万元                       │
│ ⏰ 时机把握:                                    │
│   • 短期1-2周等待技术面修复                     │
│   • 中期关注Q1财报（预计4月下旬）               │
│ 🛡️ 风险控制:                                   │
│   • 止损位: ¥55（-15%），严格执行               │
│   • 仓位上限: 不超过12%（避免单股集中风险）     │
│                                                │
│ 🔍 关键事件:                                    │
│ • 国家发改委出台消费刺激政策（利好）            │
│ • 公司Q4业绩预告净利+8%（符合预期）             │
│                                                │
│ 📈 3个月目标价: ¥78-82 (涨幅 +18% ~ +25%)      │
│ 📈 6个月目标价: ¥85-90 (涨幅 +29% ~ +37%)      │
│                                                │
│ ⏱️ 分析时间: 2025-01-17 15:35                  │
│ 💬 Token消耗: 156                              │
│                                                │
│ [查看详情] [对话追问💬] [查看我的评价]         │
└────────────────────────────────────────────────┘
```

**关键字段说明**：
- **AI综合评分**：1-10分，综合基本面、技术面、估值得出
- **核心观点**：3-5条要点总结
- **建议操作策略**：
  - 加仓价位：具体价格区间和对应仓位比例
  - 资金配置：金额和组合占比建议
  - 时机把握：时间窗口和关键节点
  - 风险控制：止损位和仓位上限
- **目标价**：3个月、6个月预期涨幅

##### 2.11.2.4 汇总视图

**所有股票AI建议汇总表**：
| 股票 | 当前价 | AI评分 | AI建议 | 加仓价位 | 目标涨幅(3M) | 风险等级 | 操作 |
|------|--------|--------|--------|----------|--------------|----------|------|
| 青岛啤酒 | ¥65.8 | 7.2 | 持有+加仓 | ¥62-64 | +18% ~ +25% | 中 | 详情 |
| 腾讯控股 | HK$368 | 8.5 | 持有 | - | +15% ~ +22% | 低 | 详情 |
| 宁德时代 | ¥195.8 | 6.8 | 减仓 | - | +5% ~ +10% | 高 | 详情 |
| 茅台 | ¥1650 | 9.2 | 买入 | ¥1630-1650 | +20% ~ +30% | 中 | 详情 |

**快捷筛选**：
- 按AI建议过滤（买入/持有/减仓/卖出）
- 按风险等级过滤
- 按评分排序

---

#### 2.11.3 场景二：AI股票推荐

##### 2.11.3.1 推荐触发机制

**AI主动推荐时机**：
- **事件驱动**：检测到重大利好事件（如政策发布、业绩超预期）
- **技术信号**：股票出现明显买入信号（如MACD金叉、突破关键阻力位）
- **估值机会**：优质股票回调至合理估值区间
- **行业轮动**：某行业进入上升周期

**推送方式**：
- 前端实时通知（WebSocket）
- 仪表板"AI推荐"专区展示
- 可配置推送频率（实时/每日汇总/关闭）

##### 2.11.3.2 推荐卡片设计

```
┌─ 🚀 AI买入推荐 ────────────────────────────────┐
│ 宁德时代 (300750) · A股 · 新能源汽车            │
│                                                │
│ 推荐原因: 回调至合理估值，行业政策利好          │
│ 推荐时间: 2025-01-17 14:25                     │
│ 当前价: ¥195.80   合理价值区间: ¥190-220       │
│                                                │
│ 📊 AI评分: 8.8/10 (强烈推荐)                   │
│ ────────────────────────────────────────       │
│ 基本面: 9/10  技术面: 8/10  估值: 9/10         │
│                                                │
│ 💡 推荐理由:                                    │
│ 1. 新能源汽车政策利好，行业销量持续增长         │
│ 2. 公司市占率35%，稳居全球电池龙头              │
│ 3. 技术面近期回调8%，MACD即将金叉              │
│ 4. 当前PE 25x，低于历史均值30x，估值合理       │
│ 5. 机构最新调研显示Q1订单饱满                   │
│                                                │
│ 📋 建议购买策略:                                │
│ 🎯 买入策略:                                    │
│   • 第一批: ¥195-198，建仓30%（约1.5-2万）     │
│   • 第二批: 回调至¥185-190，加仓40%（约2-2.5万）│
│   • 第三批: 继续回调至¥180，加仓30%（约1.5-2万）│
│                                                │
│ 💰 资金配置:                                    │
│   • 建议总投入: ¥30,000 - 50,000               │
│   • 占组合比例: 10-15%（根据风险承受能力）      │
│   • 不建议一次性全仓买入                        │
│                                                │
│ ⏰ 时机选择:                                    │
│   • 优先级1: 本周内开始建仓（当前价格合理）     │
│   • 优先级2: 等待回调至¥185-190（更优价格）     │
│   • 最晚时间: 2周内（避免错过最佳买点）         │
│   • 关键节点: 下周三公布行业数据，可能催化     │
│                                                │
│ 🛡️ 风险控制:                                   │
│   • 止损位: ¥170（-13%），跌破果断离场         │
│   • 止盈位: ¥250（+28%），分批止盈              │
│   • 仓位上限: 15%（避免单股集中风险）           │
│   • 回撤预警: 单日跌幅>5%时重新评估             │
│                                                │
│ 📈 预期收益:                                    │
│ • 3个月目标: ¥230-250 (涨幅 +17% ~ +28%)       │
│ • 6个月目标: ¥270-300 (涨幅 +38% ~ +53%)       │
│ • 风险收益比: 1:2.2 (风险13%，收益28%)         │
│                                                │
│ ⚠️ 主要风险:                                   │
│ • 行业竞争加剧（特斯拉/比亚迪自研电池）         │
│ • 原材料价格波动（锂价）                        │
│ • 政策变化风险（补贴退坡）                      │
│                                                │
│ 📊 技术指标:                                    │
│ • RSI: 42 (超卖区间，反弹概率大)               │
│ • MACD: 即将金叉                                │
│ • 支撑位: ¥185、¥180                            │
│ • 阻力位: ¥210、¥230                            │
│                                                │
│ ⏱️ 分析时间: 2025-01-17 14:25                  │
│ 💬 Token消耗: 245                              │
│                                                │
│ [采纳建议] [暂不考虑] [对话追问💬]              │
└────────────────────────────────────────────────┘
```

**与"每日分析"的区别**：
- **主动推送** vs 用户触发
- **买入机会为主** vs 持仓全面分析
- **更详细的购买策略**（分批建仓、具体金额）
- **风险收益比分析**

##### 2.11.3.3 推荐管理

**推荐列表页**：
- 今日推荐（最新）
- 历史推荐（可筛选已采纳/已忽略）
- 推荐有效期（如72小时，过期标记为"已失效"）

**采纳后续动作**：
- 自动添加到关注列表（如未关注）
- 自动设置目标价和止损位（从AI建议中提取）
- 推荐记录标记为"已采纳"

---

#### 2.11.4 场景三：每日复盘总结

##### 2.11.4.1 触发时机

**自动触发**：
- 每日收盘后15:30（A股）
- 港股/美股闭市后1小时

**手动触发**：
- 仪表板"生成每日复盘"按钮
- 支持自定义时间范围（昨日/本周/本月）

##### 2.11.4.2 复盘报告结构

```
┌─ 📅 每日复盘 · 2025-01-17 ────────────────────┐
│                                                │
│ ═══════════════════════════════════════        │
│ 一、今日市场总结                                │
│ ═══════════════════════════════════════        │
│                                                │
│ 📊 大盘表现:                                    │
│ • 上证指数: 3,245 (+0.8%)                      │
│ • 深证成指: 10,568 (+1.2%)                     │
│ • 恒生指数: 18,432 (-0.3%)                     │
│ • 纳斯达克: 15,234 (+0.5%)                     │
│                                                │
│ 🔥 热点板块:                                    │
│ 1. 新能源汽车 (+3.2%) - 政策利好催化           │
│ 2. 人工智能 (+2.5%) - 大模型应用加速           │
│ 3. 消费电子 (+1.8%) - 苹果新品发布在即         │
│                                                │
│ 📉 疲软板块:                                    │
│ 1. 房地产 (-1.5%) - 销售数据不及预期           │
│ 2. 医药 (-0.8%) - 集采政策影响                 │
│                                                │
│ ═══════════════════════════════════════        │
│ 二、我的持仓表现                                │
│ ═══════════════════════════════════════        │
│                                                │
│ 💼 今日盈亏: +¥3,250 (+1.2%)                   │
│ 📈 涨幅前3:                                     │
│ • 宁德时代 +2.3% (¥+980)                       │
│ • 腾讯控股 +1.5% (¥+750)                       │
│ • 青岛啤酒 +0.8% (¥+320)                       │
│                                                │
│ 📉 跌幅前3:                                     │
│ • 万科A -1.2% (¥-150)                          │
│ • 招商银行 -0.5% (¥-80)                        │
│                                                │
│ 💡 AI点评:                                      │
│ • 宁德时代受益于新能源政策，建议继续持有        │
│ • 万科A建议减仓，行业基本面未见改善             │
│                                                │
│ ═══════════════════════════════════════        │
│ 三、重要事件影响                                │
│ ═══════════════════════════════════════        │
│                                                │
│ 🏛️ 政策事件 (2条):                             │
│ • 发改委发布新能源汽车消费刺激政策              │
│   影响: 宁德时代(+)、比亚迪(+)                 │
│ • 央行降准0.25个百分点                          │
│   影响: 全市场流动性改善                        │
│                                                │
│ 📊 公司事件 (1条):                              │
│ • 青岛啤酒Q4业绩预告: 净利+8% (符合预期)       │
│   影响: 短期中性，长期利好                      │
│                                                │
│ ═══════════════════════════════════════        │
│ 四、明日预测 🔮                                 │
│ ═══════════════════════════════════════        │
│                                                │
│ 🎯 大盘研判:                                    │
│ • 预计震荡上行，关注3,250-3,280区间            │
│ • 成交量可能放大，资金情绪转暖                  │
│ • 支撑位: 3,230  阻力位: 3,280                 │
│                                                │
│ 🔥 关注板块:                                    │
│ 1. 新能源汽车 - 政策效应持续发酵               │
│ 2. 消费电子 - 苹果产业链                        │
│                                                │
│ ⚠️ 风险提示:                                   │
│ • 美联储议息会议纪要公布（北京时间03:00）       │
│ • 关注外盘波动对A股开盘影响                     │
│                                                │
│ 📋 明日操作建议:                                │
│ 1. 宁德时代: 如回调至¥190-195，可考虑加仓      │
│ 2. 万科A: 反弹至¥9.2-9.5可考虑减仓             │
│ 3. 关注列表: 比亚迪、理想汽车可能有机会         │
│                                                │
│ ═══════════════════════════════════════        │
│ 五、未来一周展望                                │
│ ═══════════════════════════════════════        │
│                                                │
│ 📅 重要时间节点:                                │
│ • 周三 (1/19): 行业销量数据公布                │
│ • 周五 (1/21): A股期权交割日，注意波动         │
│                                                │
│ 🎯 关键事件跟踪:                                │
│ • 春节消费数据 (预计1/22公布)                   │
│ • 青岛啤酒年报 (预计2月初)                      │
│                                                │
│ 💡 策略建议:                                    │
│ • 短期: 持股为主，逢低加仓优质标的              │
│ • 中期: 关注Q1业绩预告窗口期（2-3月）           │
│ • 长期: 维持均衡配置，控制单股仓位              │
│                                                │
│ ⏱️ 生成时间: 2025-01-17 15:45                  │
│ 💬 Token消耗: 580                              │
│                                                │
│ [导出报告] [分享] [对话追问💬]                  │
└────────────────────────────────────────────────┘
```

**核心亮点**：
- **五大模块**：市场总结、持仓表现、事件影响、明日预测、一周展望
- **明日预测**：具体价格区间、板块机会、风险提示
- **未来展望**：关键时间节点、策略建议

##### 2.11.4.3 历史复盘查询

**时间维度**：
- 每日复盘归档
- 周度/月度汇总（AI自动生成）
- 支持时间范围筛选（最近7天/30天/自定义）

**对比分析**：
- AI预测 vs 实际走势对比
- 统计AI预测准确率
- 优化AI模型参数

---

#### 2.11.5 用户股票评价系统 ⭐

> **核心价值**：记录用户对每个公司的主观判断，形成"AI客观分析 + 用户主观评价"的双轨决策体系。

##### 2.11.5.1 评价入口

**多个入口触达**：
1. 股票详情页 - "我的评价"标签页
2. 持仓列表 - 每行"评价"按钮
3. AI分析结果卡片 - "查看我的评价"
4. 关注列表 - 快捷评价

##### 2.11.5.2 评价表单设计

```
┌─ 我的评价 · 宁德时代 (300750) ─────────────────┐
│                                                │
│ 综合评分: ★★★★☆ (4星)                         │
│                                                │
│ ─────────────────────────────────────          │
│ 💚 看好原因:                                    │
│ ─────────────────────────────────────          │
│ 1. [✏️] 新能源汽车龙头，市占率35%稳居第一       │
│ 2. [✏️] 垂直整合能力强，电池自给自足降低成本    │
│ 3. [✏️] 技术研发领先，4C快充、钠离子电池布局    │
│ 4. [✏️] 客户结构优质，与特斯拉、理想深度绑定    │
│ 5. [➕ 添加]                                    │
│                                                │
│ ⚠️ 不看好/风险点:                              │
│ ─────────────────────────────────────          │
│ 1. [✏️] 行业竞争加剧，特斯拉/理想等竞争对手强   │
│ 2. [✏️] 毛利率有下行压力，价格战风险            │
│ 3. [✏️] 锂价波动影响成本，上游议价能力弱        │
│ 4. [➕ 添加]                                    │
│                                                │
│ 📌 持有原因/投资逻辑:                           │
│ ─────────────────────────────────────          │
│ 这是我的核心资产配置，长期持有3-5年。看好      │
│ 新能源汽车渗透率持续提升（当前35%→50%），     │
│ 宁德作为行业龙头将持续受益。虽然短期有竞争     │
│ 压力，但技术护城河和规模优势依然明显。         │
│                                                │
│ 当前策略: 逢低加仓，目标仓位15%（当前10%）     │
│                                                │
│ 🎯 目标价: ¥280  (个人预期，基于PE 30x)        │
│ 🛡️ 止损价: ¥170  (基于技术支撑位)              │
│                                                │
│ ─────────────────────────────────────          │
│ 📝 操作日志:                                    │
│ ─────────────────────────────────────          │
│ • 2025-01-17: 更新看好原因第3条（4C快充）      │
│ • 2025-01-15: 增加风险点"毛利率压力"           │
│ • 2025-01-10: 首次建仓¥198，买入500股          │
│                                                │
│ [保存] [取消]                                   │
└────────────────────────────────────────────────┘
```

**字段说明**：
- **综合评分**：1-5星，用户主观打分
- **看好原因**：数组形式，可添加/编辑/删除
- **不看好/风险点**：数组形式，记录风险意识
- **持有逻辑**：长文本，记录投资thesis
- **目标价/止损价**：用户自己设定（可不同于AI建议）
- **操作日志**：自动记录评价修改历史

##### 2.11.5.3 评价与AI分析的联动

**在AI分析中显示用户评价**：
```
┌─ 青岛啤酒 AI分析 ──────────────────────────────┐
│ ... (AI分析内容) ...                           │
│                                                │
│ ─────────────────────────────────────          │
│ 📝 我的评价 (上次更新: 2025-01-15)             │
│ ─────────────────────────────────────          │
│ 评分: ★★★★☆ (4星)                             │
│ 看好: 白酒复苏利好、估值合理、分红稳定         │
│ 风险: 行业增速放缓、竞争加剧                    │
│ 策略: 长期持有，目标仓位12%                     │
│                                                │
│ [编辑评价]                                      │
└────────────────────────────────────────────────┘
```

**在每日复盘中汇总评价**：
```
═══════════════════════════════════════
六、我的投资观点汇总
═══════════════════════════════════════

📊 我的高评分股票 (4星及以上):
1. 宁德时代 (★★★★★) - 新能源龙头，长期配置
2. 腾讯控股 (★★★★☆) - 互联网稳健标的
3. 青岛啤酒 (★★★★☆) - 消费防御，分红稳定

⚠️ 我的低评分股票 (2星及以下):
1. 万科A (★★☆☆☆) - 行业基本面差，计划减仓

💡 AI与我的观点对比:
• 宁德时代: AI 8.8分 vs 我 5星 ✅ 高度一致
• 万科A: AI 5.2分 vs 我 2星 ✅ 一致看空
• 招商银行: AI 7.5分 vs 我 3星 ⚠️ 存在分歧
  → 建议: 重新评估招商银行，关注银行板块变化
```

##### 2.11.5.4 评价历史与回顾

**评价变更日志**：
- 记录每次评价的修改（看好/不看好原因的增删改）
- 关联当时的AI分析结果
- 关联实际操作（买入/卖出）

**回顾与复盘**：
```
┌─ 宁德时代 - 我的评价历史 ──────────────────────┐
│                                                │
│ 📅 2025-01-17 (当前)                           │
│ 评分: ★★★★★  看好原因: 4条  风险点: 3条       │
│ 当时价格: ¥195.8  持仓: 500股                  │
│                                                │
│ 📅 2025-01-10 (首次评价)                       │
│ 评分: ★★★★☆  看好原因: 3条  风险点: 2条       │
│ 当时价格: ¥198.0  持仓: 500股 (首次买入)       │
│                                                │
│ 📊 AI准确性验证:                                │
│ • 我当时预期: 3个月涨至¥230 (+16%)             │
│ • AI当时预测: 3个月¥220-240 (+11%~+21%)       │
│ • 实际表现: (待验证，当前仅7天)                 │
│                                                │
│ [查看详情]                                      │
└────────────────────────────────────────────────┘
```

---

#### 2.11.6 AI对话追问功能

##### 2.11.6.1 对话入口

**任何AI分析结果都可追问**：
- 每日分析结果卡片 - "对话追问💬"按钮
- AI推荐卡片 - "对话追问💬"
- 每日复盘报告 - "对话追问💬"
- 股票详情页 - "AI助手"标签页

##### 2.11.6.2 对话界面设计

```
┌─ AI对话 · 宁德时代 (300750) ───────────────────┐
│                                                │
│ 📄 关联分析: 2025-01-17 每日分析               │
│                                                │
│ ─────────────────────────────────────          │
│ 💬 对话历史                                     │
│ ─────────────────────────────────────          │
│                                                │
│ [我] 15:40                                      │
│ 你提到"技术面MACD即将金叉"，具体什么时候？     │
│                                                │
│ [AI] 15:40                                      │
│ 根据当前技术指标，MACD差值(DIF-DEA)为-0.35，   │
│ 正在快速收敛。预计在未来2-3个交易日内金叉。    │
│ 历史统计显示，宁德时代MACD金叉后，5日内上涨    │
│ 概率68%，平均涨幅+2.3%。                        │
│                                                │
│ [我] 15:42                                      │
│ 如果我现在买入，3个月后卖出，预期收益率多少？  │
│                                                │
│ [AI] 15:42                                      │
│ 基于以下分析:                                   │
│ • 当前价: ¥195.8                                │
│ • 3个月目标价: ¥230-250 (中位数¥240)           │
│ • 预期涨幅: +22.6%                              │
│                                                │
│ 风险提示:                                       │
│ • 乐观情况(30%概率): ¥250 (+27.7%)             │
│ • 基准情况(50%概率): ¥230-240 (+17%~+23%)      │
│ • 悲观情况(20%概率): ¥180-200 (-8%~+2%)        │
│                                                │
│ 综合期望收益: +18.5% (考虑各场景概率)           │
│                                                │
│ [我] 15:45                                      │
│ 和比亚迪比，我应该选哪个？                      │
│                                                │
│ [AI] 15:45                                      │
│ 对比分析:                                       │
│                                                │
│ 宁德时代 (300750):                              │
│ • 优势: 全球电池龙头，技术领先，客户优质        │
│ • 劣势: 估值较高(PE 25x)，竞争压力              │
│ • AI评分: 8.8/10                                │
│ • 3月预期: +22.6%                               │
│                                                │
│ 比亚迪 (002594):                                │
│ • 优势: 垂直整合，整车+电池双轮驱动             │
│ • 劣势: 价格战压力大，毛利率下滑                │
│ • AI评分: 7.9/10                                │
│ • 3月预期: +15.2%                               │
│                                                │
│ 💡 建议:                                        │
│ 如果你追求更高收益且能承受波动，选宁德时代。    │
│ 如果你希望更稳健，两者各配置50%也是好选择。     │
│                                                │
│ ─────────────────────────────────────          │
│ ✍️ 你的问题:                                    │
│ [输入框: 还有什么问题...]                       │
│                                  [发送 📤]      │
└────────────────────────────────────────────────┘
```

##### 2.11.6.3 对话上下文管理

**自动携带上下文**：
- 关联的AI分析结果（完整内容）
- 股票基本信息（价格、持仓、成本等）
- 最近的事件（过去7天）
- 用户评价（如有）

**会话管理**：
- 每个股票独立会话
- 会话保留7天（超过自动归档）
- 支持导出对话记录

##### 2.11.6.4 操作后自动re-analyze

**触发条件**：
- 用户采纳AI建议并执行买入/卖出后
- 用户添加/修改股票评价后
- 用户设置新的目标价/止损价后

**Re-analyze行为**：
```
[AI] 检测到你刚刚买入了宁德时代500股，¥195.8/股

我已自动更新分析:
• 当前持仓: 500股 → 1000股
• 持仓成本: ¥198 → ¥196.9
• 仓位占比: 10% → 15%

基于新的仓位，更新建议:
• 建议暂停加仓，当前已达目标仓位15%
• 新的止损位: ¥170 (对应总损失-13.7%)
• 新的止盈位: ¥250 (对应总收益+27.0%)

[查看完整分析] [继续对话]
```

---

#### 2.11.7 数据表设计

##### 2.11.7.1 AI决策记录表 (`ai_decisions`)

```sql
CREATE TABLE ai_decisions (
  id BIGSERIAL PRIMARY KEY,
  user_id BIGINT NOT NULL,

  -- 决策类型
  decision_type VARCHAR(50) NOT NULL,
    -- 'daily_analysis'（每日分析）
    -- 'stock_recommendation'（股票推荐）
    -- 'daily_review'（每日复盘）
    -- 'on_demand'（用户主动触发）

  -- 关联信息
  symbol VARCHAR(20),  -- 单股分析时填写
  account_id BIGINT,   -- 如关联特定账户

  -- 分析输入
  input_context JSONB,
    -- 示例: {
    --   "selected_symbols": ["600600", "00700", "300750"],
    --   "user_holdings": [...],
    --   "recent_events": [...],
    --   "market_data": {...}
    -- }

  -- AI输出
  ai_response JSONB NOT NULL,
    -- 示例: {
    --   "overall_score": 7.2,
    --   "recommendation": "持有+加仓",
    --   "key_points": [...],
    --   "buy_strategy": {...},
    --   "risk_control": {...},
    --   "target_prices": {...}
    -- }

  -- Token使用
  tokens_used INT,

  -- 状态与时间
  status VARCHAR(20) DEFAULT 'completed',
    -- 'pending'（分析中）
    -- 'completed'（已完成）
    -- 'failed'（失败）

  created_at TIMESTAMPTZ DEFAULT NOW(),
  completed_at TIMESTAMPTZ,

  -- 用户反馈
  user_action VARCHAR(50),
    -- 'adopted'（采纳）
    -- 'ignored'（忽略）
    -- 'partial'（部分采纳）
  user_feedback TEXT,  -- 用户评论

  -- 索引
  INDEX idx_user_decisions (user_id, created_at DESC),
  INDEX idx_symbol_decisions (symbol, created_at DESC),
  INDEX idx_decision_type (decision_type)
);
```

##### 2.11.7.2 AI对话历史表 (`ai_conversations`)

```sql
CREATE TABLE ai_conversations (
  id BIGSERIAL PRIMARY KEY,
  user_id BIGINT NOT NULL,

  -- 会话标识
  session_id VARCHAR(100) NOT NULL,
    -- 格式: {user_id}_{symbol}_{timestamp}
    -- 示例: 1001_300750_20250117

  -- 关联分析
  related_decision_id BIGINT,
    -- 关联的ai_decisions.id
  related_symbol VARCHAR(20),

  -- 消息内容
  message_type VARCHAR(20) NOT NULL,
    -- 'user'（用户提问）
    -- 'assistant'（AI回复）
    -- 'system'（系统消息，如"检测到你刚买入..."）

  message_content TEXT NOT NULL,

  -- 上下文（AI回复时使用）
  context_data JSONB,
    -- 携带的上下文信息（股票数据、持仓、事件等）

  -- Token使用（仅AI回复时记录）
  tokens_used INT,

  -- 时间
  created_at TIMESTAMPTZ DEFAULT NOW(),

  -- 索引
  INDEX idx_session (session_id, created_at),
  INDEX idx_user_conversations (user_id, created_at DESC)
);
```

##### 2.11.7.3 关注股票表 (`watchlist`)

```sql
CREATE TABLE watchlist (
  id BIGSERIAL PRIMARY KEY,
  user_id BIGINT NOT NULL,
  symbol VARCHAR(20) NOT NULL,

  -- 市场类型
  market VARCHAR(10) NOT NULL,
    -- 'CN', 'HK', 'US'

  -- 关注原因
  watch_reason TEXT,
    -- 用户添加时填写（可选）

  -- 目标价与止损（可选）
  target_price NUMERIC(20,8),
  stop_loss_price NUMERIC(20,8),

  -- 提醒配置
  alert_on_target_price BOOLEAN DEFAULT TRUE,
  alert_on_news BOOLEAN DEFAULT FALSE,
  alert_on_ai_recommendation BOOLEAN DEFAULT TRUE,

  -- 优先级（用于AI分析排序）
  priority INT DEFAULT 1,
    -- 1: 低  2: 中  3: 高

  -- 时间
  added_at TIMESTAMPTZ DEFAULT NOW(),
  last_ai_analysis_at TIMESTAMPTZ,

  -- 软删除
  is_deleted BOOLEAN DEFAULT FALSE,
  deleted_at TIMESTAMPTZ,

  UNIQUE(user_id, symbol),
  INDEX idx_user_watchlist (user_id, is_deleted, priority DESC)
);
```

##### 2.11.7.4 用户股票评价表 (`user_stock_reviews`)

```sql
CREATE TABLE user_stock_reviews (
  id BIGSERIAL PRIMARY KEY,
  user_id BIGINT NOT NULL,
  symbol VARCHAR(20) NOT NULL,

  -- 综合评分
  rating INT CHECK (rating >= 1 AND rating <= 5),
    -- 1-5星

  -- 看好原因（数组）
  bullish_reasons TEXT[],
    -- 示例: ARRAY['市占率第一', '技术领先', '客户优质']

  -- 不看好/风险原因（数组）
  bearish_reasons TEXT[],
    -- 示例: ARRAY['竞争加剧', '毛利率压力']

  -- 持有逻辑（长文本）
  holding_logic TEXT,

  -- 目标价与止损（用户自己设定）
  target_price NUMERIC(20,8),
  stop_loss_price NUMERIC(20,8),

  -- 投资策略备注
  strategy_notes TEXT,
    -- 如"逢低加仓，目标仓位15%"

  -- 时间
  last_updated TIMESTAMPTZ DEFAULT NOW(),
  created_at TIMESTAMPTZ DEFAULT NOW(),

  UNIQUE(user_id, symbol),
  INDEX idx_user_reviews (user_id, last_updated DESC)
);
```

##### 2.11.7.5 评价日志表 (`review_logs`)

```sql
CREATE TABLE review_logs (
  id BIGSERIAL PRIMARY KEY,
  review_id BIGINT NOT NULL,
    -- 关联user_stock_reviews.id

  user_id BIGINT NOT NULL,
  symbol VARCHAR(20) NOT NULL,

  -- 变更类型
  log_type VARCHAR(50) NOT NULL,
    -- 'created'（首次创建）
    -- 'rating_changed'（评分变更）
    -- 'bullish_reasons_updated'（看好原因更新）
    -- 'bearish_reasons_updated'（风险原因更新）
    -- 'logic_updated'（持有逻辑更新）
    -- 'targets_updated'（目标价/止损价更新）

  -- 变更内容（快照）
  change_snapshot JSONB,
    -- 示例: {
    --   "old_rating": 4,
    --   "new_rating": 5,
    --   "added_reasons": ["4C快充技术"],
    --   "removed_reasons": []
    -- }

  -- 关联的价格和持仓（用于回顾）
  stock_price_at_time NUMERIC(20,8),
  holding_quantity INT,
  holding_cost NUMERIC(20,8),

  -- 时间
  created_at TIMESTAMPTZ DEFAULT NOW(),

  INDEX idx_review_logs (review_id, created_at DESC),
  INDEX idx_user_logs (user_id, symbol, created_at DESC)
);
```

---

#### 2.11.8 API设计

##### 2.11.8.1 每日AI分析API

**POST** `/api/v1/ai/daily-analysis`

请求体:
```json
{
  "selected_symbols": ["600600", "00700", "300750"],
  "include_holdings": true,
  "include_watchlist": true
}
```

响应:
```json{
  "analysis_id": 12345,
  "status": "processing",
  "total_stocks": 3,
  "estimated_tokens": 800,
  "estimated_time": "约60秒",
  "results": [
    {
      "symbol": "600600",
      "status": "completed",
      "ai_score": 7.2,
      "recommendation": "持有+加仓",
      "key_points": [...],
      "buy_strategy": {...},
      "tokens_used": 156
    }
  ]
}
```

##### 2.11.8.2 获取AI推荐API

**GET** `/api/v1/ai/recommendations`

查询参数:
- `status`: active（有效）| expired（已过期）| adopted（已采纳）
- `limit`: 返回数量（默认10）

响应:
```json
{
  "recommendations": [
    {
      "id": 5678,
      "symbol": "300750",
      "recommendation_type": "buy",
      "ai_score": 8.8,
      "reason": "回调至合理估值，行业政策利好",
      "buy_strategy": {...},
      "expires_at": "2025-01-20T15:30:00Z",
      "created_at": "2025-01-17T14:25:00Z"
    }
  ]
}
```

##### 2.11.8.3 生成每日复盘API

**POST** `/api/v1/ai/daily-review`

请求体:
```json
{
  "date": "2025-01-17",
  "include_forecast": true,
  "forecast_days": 1
}
```

响应:
```json
{
  "review_id": 9012,
  "date": "2025-01-17",
  "market_summary": {...},
  "portfolio_performance": {...},
  "important_events": [...],
  "tomorrow_forecast": {...},
  "weekly_outlook": {...},
  "tokens_used": 580,
  "generated_at": "2025-01-17T15:45:00Z"
}
```

##### 2.11.8.4 AI对话API

**POST** `/api/v1/ai/chat`

请求体:
```json
{
  "session_id": "1001_300750_20250117",
  "message": "你提到MACD即将金叉，具体什么时候？",
  "context": {
    "related_decision_id": 12345,
    "symbol": "300750"
  }
}
```

响应:
```json
{
  "conversation_id": 3456,
  "session_id": "1001_300750_20250117",
  "ai_response": "根据当前技术指标，MACD差值...",
  "tokens_used": 89,
  "created_at": "2025-01-17T15:40:00Z"
}
```

##### 2.11.8.5 用户评价CRUD API

**创建/更新评价** - **POST** `/api/v1/reviews/{symbol}`

```json
{
  "rating": 5,
  "bullish_reasons": [
    "新能源汽车龙头，市占率35%稳居第一",
    "垂直整合能力强，电池自给自足降低成本"
  ],
  "bearish_reasons": [
    "行业竞争加剧",
    "毛利率有下行压力"
  ],
  "holding_logic": "这是我的核心资产配置...",
  "target_price": 280.0,
  "stop_loss_price": 170.0
}
```

**获取评价** - **GET** `/api/v1/reviews/{symbol}`

**删除评价** - **DELETE** `/api/v1/reviews/{symbol}`

**获取评价历史** - **GET** `/api/v1/reviews/{symbol}/logs`

---

#### 2.11.9 前端页面路由

| 路由 | 页面名称 | 说明 |
|------|---------|------|
| `/dashboard` | 仪表板 | 新增"AI分析模块"区域 |
| `/stocks/detail/:symbol` | 股票详情页 | 新增"AI分析"、"我的评价"、"AI对话"标签页 |
| `/ai/daily-review` | 每日复盘页 | 展示每日复盘报告 |
| `/ai/recommendations` | AI推荐列表 | 展示所有AI推荐（有效/已采纳/已过期） |
| `/ai/chat/:symbol` | AI对话页 | 与AI进行对话（可选独立页面或侧边栏） |

---

#### 2.11.10 技术实现要点

##### 2.11.10.1 AI调用策略

**成本优化**：
- 批量分析时合并请求（如3支股票合并为1次API调用）
- 使用缓存（同一支股票1小时内不重复分析）
- 分级分析：Critical事件详细分析，Low事件简单分析

**实时性保障**：
- WebSocket推送AI分析进度
- 支持取消正在进行的分析
- 失败重试机制（最多3次）

##### 2.11.10.2 前端状态管理

**Pinia Store**：
- `aiStore`: 管理AI分析状态、结果、对话历史
- `reviewStore`: 管理用户评价数据
- `stockStore`: 管理股票数据（价格、持仓等）

**状态同步**：
- AI分析完成后自动更新相关股票数据
- 用户评价修改后自动刷新评价日志
- WebSocket实时同步AI推荐

##### 2.11.10.3 性能优化

**懒加载**：
- AI对话历史按需加载（滚动加载）
- 评价日志分页加载

**缓存策略**：
- AI分析结果缓存1小时（Redis）
- 用户评价数据本地缓存（IndexedDB）

---

#### 2.11.11 未来扩展

**P2阶段**（可选）：
- **AI学习用户偏好**：根据用户历史评价，调整AI推荐权重
- **多用户协作评价**：支持与好友/社区分享股票评价
- **AI准确率统计**：追踪AI预测vs实际表现，反馈优化模型
- **语音对话**：支持语音与AI交互
- **自动交易集成**：AI建议直接下单（需券商API支持）

---

