<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æŠ•èµ„ç®¡ç†ç³»ç»Ÿ v3.1 - æ•°æ®åº“ ER å›¾</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            background: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 1.8rem;
            margin-bottom: 0.5rem;
        }

        .header p {
            opacity: 0.9;
            font-size: 0.95rem;
        }

        .container {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 1rem;
        }

        .nav-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid #e0e0e0;
            flex-wrap: wrap;
        }

        .nav-tab {
            padding: 0.75rem 1.5rem;
            background: white;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 0.95rem;
            transition: all 0.3s ease;
            color: #666;
        }

        .nav-tab:hover {
            color: #667eea;
            background: #f8f9fa;
        }

        .nav-tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
            font-weight: 500;
        }

        .tab-content {
            display: none;
            background: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .tab-content.active {
            display: block;
        }

        .mermaid {
            text-align: center;
            background: white;
            padding: 1rem;
            border-radius: 4px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
        }

        th, td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #555;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 3px;
            font-size: 0.75rem;
            font-weight: 500;
            margin-left: 0.5rem;
        }

        .badge-new {
            background: #d4edda;
            color: #155724;
        }

        .badge-v31 {
            background: #fff3cd;
            color: #856404;
        }

        .info-box {
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 6px;
            border-left: 4px solid #667eea;
            background: #f8f9ff;
        }

        .info-box h3 {
            margin-bottom: 0.5rem;
            color: #667eea;
        }

        code {
            background: #f4f4f4;
            padding: 0.2rem 0.4rem;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
        }

        pre {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 6px;
            overflow-x: auto;
            margin: 1rem 0;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>æŠ•èµ„ç®¡ç†ç³»ç»Ÿ v3.1 - æ•°æ®åº“ ER å›¾</h1>
        <p>ğŸ“Š æ€»è¡¨æ•°: 33å¼  | æ ¸å¿ƒè¡¨: 13å¼  | ç‰ˆæœ¬: v1.1 | æ—¥æœŸ: 2025-01-15</p>
    </div>

    <div class="container">
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('core-er')">æ ¸å¿ƒERå›¾</button>
            <button class="nav-tab" onclick="showTab('tables')">è¡¨åˆ†ç±»</button>
            <button class="nav-tab" onclick="showTab('indexes')">ç´¢å¼•ç­–ç•¥</button>
            <button class="nav-tab" onclick="showTab('relations')">å…³ç³»è¯´æ˜</button>
        </div>

        <!-- Tab 1: Core ER Diagram -->
        <div id="core-er" class="tab-content active">
            <h2>æ ¸å¿ƒ ER å›¾ï¼ˆ13å¼ æ ¸å¿ƒè¡¨ï¼‰</h2>
            <div class="info-box">
                <h3>è®¾è®¡åŸåˆ™</h3>
                <p>è™šæ‹Ÿå¤–é”® | è´¦æˆ·éš”ç¦» | å¹‚ç­‰æ€§ä¿è¯ | JSONB çµæ´»æ€§</p>
            </div>

            <div class="mermaid">
erDiagram
    users ||--o{ accounts : owns
    users ||--o{ ai_token_transactions : has

    users {
        bigint id PK
        text email UK
        text user_name
        text status
        timestamptz created_at
    }

    accounts {
        bigint id PK
        bigint user_id FK
        text account_name
        text type
        text status
        jsonb fee_config
        timestamptz created_at
    }

    ai_token_transactions {
        bigint id PK
        bigint user_id FK
        text transaction_type
        bigint amount
        bigint balance_after
        timestamptz created_at
    }

    stocks {
        bigint id PK
        text symbol UK
        text name
        text market
        text exchange
        text sector
    }

    accounts ||--o{ holdings : holds
    stocks ||--o{ holdings : held_by

    holdings {
        bigint id PK
        bigint user_id FK
        bigint account_id FK
        text symbol FK
        numeric quantity
        numeric avg_cost
        jsonb user_tags
        jsonb ai_tags
    }

    accounts ||--o{ watchlist : watches
    stocks ||--o{ watchlist : watched_by

    watchlist {
        bigint id PK
        bigint user_id FK
        bigint account_id FK
        text symbol FK
        numeric target_price
        text notes
    }

    accounts ||--o{ trade_records : trades
    stocks ||--o{ trade_records : traded

    trade_records {
        bigint id PK
        bigint user_id FK
        bigint account_id FK
        text symbol FK
        text trade_type
        numeric quantity
        numeric price
        text idempotency_key UK
        timestamptz trade_time
    }

    stocks ||--o{ price_snapshots : has_price

    price_snapshots {
        bigint id PK
        text symbol FK
        numeric price
        numeric volume
        timestamptz snapshot_time
        text source
    }

    stocks ||--o{ company_events : has_events

    company_events {
        bigint id PK
        text symbol FK
        text event_category
        text event_subcategory
        text title
        text importance
        date event_date
        text idempotency_key UK
    }

    company_events ||--o{ event_analysis : analyzed_by

    event_analysis {
        bigint id PK
        bigint event_id FK
        bigint user_id FK
        bigint account_id FK
        jsonb market_impact
        jsonb holding_impact
        jsonb recommendation
        bigint tokens_used
    }

    accounts ||--o{ ai_strategies : has_strategies

    ai_strategies {
        bigint id PK
        bigint user_id FK
        bigint account_id FK
        text analysis_type
        jsonb recommendation
        bigint tokens_used
        timestamptz analyzed_at
    }

    ai_strategies ||--o{ strategy_evaluations : evaluated

    strategy_evaluations {
        bigint id PK
        bigint strategy_id FK
        numeric profit_loss
        text evaluation_result
        timestamptz evaluated_at
    }
            </div>
        </div>

        <!-- Tab 2: Tables -->
        <div id="tables" class="tab-content">
            <h2>è¡¨åˆ†ç±»</h2>

            <h3>æ ¸å¿ƒä¸šåŠ¡è¡¨ï¼ˆ13å¼ ï¼‰- PRD v3.1</h3>
            <table>
                <thead>
                    <tr>
                        <th>ERå›¾è¡¨å</th>
                        <th>Schemaå®é™…è¡¨å</th>
                        <th>ç”¨é€”</th>
                        <th>ä¼˜å…ˆçº§</th>
                        <th>çŠ¶æ€</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>users</td>
                        <td>users</td>
                        <td>ç”¨æˆ·è´¦å·</td>
                        <td>P0</td>
                        <td>âœ… å·²å®ç°</td>
                    </tr>
                    <tr>
                        <td>accounts</td>
                        <td>accounts</td>
                        <td>æŠ•èµ„è´¦æˆ·</td>
                        <td>P0</td>
                        <td>âœ… å·²å®ç°</td>
                    </tr>
                    <tr style="background: #d4edda;">
                        <td>ai_token_transactions <span class="badge badge-new">æ–°å¢</span></td>
                        <td>ai_token_transactions</td>
                        <td>AI Tokenç®¡ç†</td>
                        <td>P0</td>
                        <td>âœ… å·²å®ç°</td>
                    </tr>
                    <tr>
                        <td>stocks</td>
                        <td>company_info</td>
                        <td>è‚¡ç¥¨ä¿¡æ¯</td>
                        <td>P0</td>
                        <td>âœ… å·²å®ç°</td>
                    </tr>
                    <tr>
                        <td>price_snapshots</td>
                        <td>price_snapshots</td>
                        <td>ä»·æ ¼å¿«ç…§</td>
                        <td>P0</td>
                        <td>âœ… å·²å®ç°</td>
                    </tr>
                    <tr>
                        <td>holdings</td>
                        <td>holdings</td>
                        <td>æŒä»“</td>
                        <td>P0</td>
                        <td>âœ… å·²å®ç°</td>
                    </tr>
                    <tr>
                        <td>watchlist</td>
                        <td>watchlist</td>
                        <td>å…³æ³¨åˆ—è¡¨</td>
                        <td>P0</td>
                        <td>âœ… å·²å®ç°</td>
                    </tr>
                    <tr>
                        <td>trade_records</td>
                        <td>trade_events</td>
                        <td>äº¤æ˜“è®°å½•</td>
                        <td>P0</td>
                        <td>âœ… å·²å®ç°</td>
                    </tr>
                    <tr>
                        <td>ai_strategies</td>
                        <td>strategy_analysis</td>
                        <td>AIç­–ç•¥</td>
                        <td>P0</td>
                        <td>âœ… å·²å®ç°</td>
                    </tr>
                    <tr style="background: #d4edda;">
                        <td>strategy_evaluations <span class="badge badge-new">æ–°å¢</span></td>
                        <td>strategy_evaluations</td>
                        <td>ç­–ç•¥è¯„ä¼°</td>
                        <td>P1</td>
                        <td>âœ… å·²å®ç°</td>
                    </tr>
                    <tr style="background: #fff3cd;">
                        <td><strong>company_events</strong> <span class="badge badge-v31">v3.1æ ¸å¿ƒ</span> <span class="badge badge-new">æ–°å¢</span></td>
                        <td>company_events</td>
                        <td>å…¬å¸äº‹ä»¶</td>
                        <td>P0</td>
                        <td>âœ… å·²å®ç°</td>
                    </tr>
                    <tr style="background: #fff3cd;">
                        <td><strong>event_analysis</strong> <span class="badge badge-v31">v3.1æ ¸å¿ƒ</span> <span class="badge badge-new">æ–°å¢</span></td>
                        <td>event_analysis</td>
                        <td>äº‹ä»¶AIåˆ†æ</td>
                        <td>P0</td>
                        <td>âœ… å·²å®ç°</td>
                    </tr>
                    <tr>
                        <td>account_preferences</td>
                        <td>account_preferences</td>
                        <td>è´¦æˆ·åå¥½</td>
                        <td>P1</td>
                        <td>âœ… å·²å®ç°</td>
                    </tr>
                </tbody>
            </table>

            <div class="info-box">
                <h3>è¡¨åæ˜ å°„è¯´æ˜</h3>
                <ul>
                    <li><code>stocks</code> (ERå›¾) â†’ <code>company_info</code> (Schema)</li>
                    <li><code>trade_records</code> (ERå›¾) â†’ <code>trade_events</code> (Schema)</li>
                    <li><code>ai_strategies</code> (ERå›¾) â†’ <code>strategy_analysis</code> (Schema)</li>
                </ul>
            </div>
        </div>

        <!-- Tab 3: Indexes -->
        <div id="indexes" class="tab-content">
            <h2>ç´¢å¼•ç­–ç•¥</h2>

            <h3>é«˜é¢‘æŸ¥è¯¢ç´¢å¼•</h3>
            <pre><code>-- ç”¨æˆ·æŸ¥è¯¢è´¦æˆ·
CREATE INDEX idx_accounts_user ON accounts(user_id);

-- è´¦æˆ·æŸ¥è¯¢æŒä»“
CREATE INDEX idx_holdings_account ON holdings(account_id, symbol);

-- ä»·æ ¼æ—¶åºæŸ¥è¯¢
CREATE INDEX idx_price_symbol_time ON price_snapshots(symbol, snapshot_time DESC);

-- äº¤æ˜“è®°å½•æŸ¥è¯¢
CREATE INDEX idx_trades_account_time ON trade_records(account_id, trade_time DESC);

-- äº‹ä»¶æŸ¥è¯¢ï¼ˆv3.1ï¼‰
CREATE INDEX idx_events_symbol_date ON company_events(symbol, event_date DESC);
CREATE INDEX idx_events_importance ON company_events(importance, event_date DESC);

-- AIåˆ†ææŸ¥è¯¢
CREATE INDEX idx_analysis_event ON event_analysis(event_id, analyzed_at DESC);
CREATE INDEX idx_analysis_account ON event_analysis(account_id, analyzed_at DESC);</code></pre>
        </div>

        <!-- Tab 4: Relations -->
        <div id="relations" class="tab-content">
            <h2>æ ¸å¿ƒå…³ç³»è¯´æ˜</h2>

            <div class="info-box">
                <h3>1. ç”¨æˆ·-è´¦æˆ·å…³ç³»ï¼ˆä¸€å¯¹å¤šï¼‰</h3>
                <p><code>users (1) â”€â”€&lt; accounts (N)</code></p>
                <p>ä¸€ä¸ªç”¨æˆ·å¯ä»¥æœ‰å¤šä¸ªæŠ•èµ„è´¦æˆ·ï¼Œè´¦æˆ·å±äºå”¯ä¸€ç”¨æˆ·</p>
            </div>

            <div class="info-box">
                <h3>2. è´¦æˆ·-æŒä»“å…³ç³»ï¼ˆä¸€å¯¹å¤šï¼‰</h3>
                <p><code>accounts (1) â”€â”€&lt; holdings (N)</code></p>
                <p><code>stocks (1) â”€â”€&lt; holdings (N)</code></p>
                <p>ä¸€ä¸ªè´¦æˆ·å¯ä»¥æŒæœ‰å¤šåªè‚¡ç¥¨ï¼ŒåŒä¸€åªè‚¡ç¥¨å¯ä»¥è¢«å¤šä¸ªè´¦æˆ·æŒæœ‰</p>
                <p>å”¯ä¸€çº¦æŸï¼š<code>(user_id, account_id, symbol)</code></p>
            </div>

            <div class="info-box">
                <h3>3. è´¦æˆ·-äº¤æ˜“è®°å½•ï¼ˆä¸€å¯¹å¤šï¼‰</h3>
                <p><code>accounts (1) â”€â”€&lt; trade_records (N)</code></p>
                <p>ä¸€ä¸ªè´¦æˆ·æœ‰å¤šç¬”äº¤æ˜“è®°å½•ï¼Œäº¤æ˜“è®°å½•å…³è”è‚¡ç¥¨</p>
                <p>å¹‚ç­‰é”®ï¼š<code>idempotency_key</code> é˜²é‡å¤</p>
            </div>

            <div class="info-box">
                <h3>4. è´¦æˆ·-AIç­–ç•¥ï¼ˆä¸€å¯¹å¤šï¼‰</h3>
                <p><code>accounts (1) â”€â”€&lt; ai_strategies (N)</code></p>
                <p><code>ai_strategies (1) â”€â”€&lt; strategy_evaluations (N)</code></p>
                <p>ä¸€ä¸ªè´¦æˆ·æœ‰å¤šä¸ªAIç­–ç•¥åˆ†æï¼Œä¸€ä¸ªç­–ç•¥å¯ä»¥æœ‰å¤šæ¬¡è¯„ä¼°è®°å½•</p>
            </div>

            <div class="info-box" style="background: #fff3cd; border-left-color: #856404;">
                <h3>5. è‚¡ç¥¨-äº‹ä»¶å…³ç³»ï¼ˆä¸€å¯¹å¤šï¼‰â­ v3.1</h3>
                <p><code>stocks (1) â”€â”€&lt; company_events (N)</code></p>
                <p><code>company_events (1) â”€â”€&lt; event_analysis (N)</code></p>
                <p>ä¸€åªè‚¡ç¥¨å¯ä»¥æœ‰å¤šä¸ªç›¸å…³äº‹ä»¶ï¼Œä¸€ä¸ªäº‹ä»¶å¯ä»¥æœ‰å¤šæ¬¡AIåˆ†æï¼ˆé’ˆå¯¹ä¸åŒç”¨æˆ·/è´¦æˆ·ï¼‰</p>
            </div>

            <div class="info-box" style="background: #fff3cd; border-left-color: #856404;">
                <h3>6. äº‹ä»¶-æŒä»“å½±å“ï¼ˆå¤šå¯¹å¤šï¼‰â­ v3.1</h3>
                <p><code>company_events (N) â”€â”€&lt; holdings (N)</code></p>
                <p>ä¸€ä¸ªäº‹ä»¶å¯èƒ½å½±å“å¤šä¸ªæŒä»“ï¼Œä¸€ä¸ªæŒä»“å¯èƒ½å—å¤šä¸ªäº‹ä»¶å½±å“</p>
                <p>é€šè¿‡ <code>event_analysis.holding_impact</code> è®°å½•å…³è”</p>
            </div>
        </div>
    </div>

    <script>
        mermaid.initialize({
            startOnLoad: true,
            theme: 'default',
            securityLevel: 'loose',
            er: {
                useMaxWidth: true
            }
        });

        function showTab(tabId) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.nav-tab').forEach(btn => {
                btn.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(tabId).classList.add('active');
            event.target.classList.add('active');
        }
    </script>
</body>
</html>
